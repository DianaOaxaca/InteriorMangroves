{
  "hash": "d69be83dd217d3a2f09ff88493ea2e4c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Data Prepare\"\n---\n\n\n\n::: callout-tip\n## How similar are coastal and inland mangroves❓\n\nTo answer this question, only samples that met the selection criteria were selected for comparison with each other. These samples were as follows:\n\n1.  They hailed from the same depth range.\n2.  They hailed from the strip, in the case of coastal mangroves.\n3.  They hailed from the flooding season, in the case of coastal mangroves.\n:::\n\n## 01. Select samples\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(qiime2R)\nlibrary(phyloseq)\n#Create phyloseq objects with qiime2 artifacts\nphyseq_qiime3 <- qza_to_phyloseq(\n  features = \"data/cluster_table_filter_freq218_emcEstero.qza\",\n  taxonomy = \"data/taxonomyEstero.qza\",\n  metadata = \"data/metadata14.tsv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Filter metadata\n# Extract metadata from phyloseq object\nmetadat <- data.frame(phyloseq::sample_data(physeq_qiime3), check.names = FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Filter metadata by Study_zone column\nfiltered_metadat <- metadat[metadat$Study_zone %in% c(\"Estero_pargo\", \"Rio San Pedro\", \"Celestún\"), ]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Filter again by Ecological Type column, selecting Fringe parameter\nfiltered_metadat2 <- filtered_metadat[filtered_metadat$Ecological_type %in% c(\"Fringe\"), ]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Filter again by season column to include all samples that were collected form a flood season\nfiltered_metadat3 <- filtered_metadat2[filtered_metadat2$season %in%c(\"flood\"),]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Filter again by season column to include all samples that were collected form the surface\nfiltered_metadat4 <- filtered_metadat3[filtered_metadat3$depth %in%c(\"0-15\", \"0.15\", \"5\"),]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Combine filtered metadata with phyloseq object to create a filtered phyloseq object\nfiltered_physeq2 <- prune_samples(rownames(filtered_metadat4), physeq_qiime3)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Save your new phyloseq object\nsaveRDS(filtered_physeq2, file = \"physeq_objeto_Estero.rds\") \n```\n:::\n\n\n\n## 02. Data preparation\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#load\nphyseq_qiime <- readRDS(\"rds/compare_mangroves/physeq_objeto_Estero.rds\")\n```\n:::\n\n\n\n### 02.1 Remove empty ASVs and singletons\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#check data\nlibrary(microbiome)\nlibrary(dplyr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(microbiome)\nmicrobiome::summarize_phyloseq(physeq_qiime)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCompositional = NO2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n1] Min. number of reads = 35812] Max. number of reads = 1504313] Total number of reads = 19263064] Average number of reads = 77052.245] Median number of reads = 783677] Sparsity = 0.5742662632375196] Any OTU sum to 1 or less? YES8] Number of singletons = 849] Percent of OTUs that are singletons \n        (i.e. exactly one read detected across all samples)010] Number of sample variables are: 25SampleIDBioSampleIDSRASampleNameCollection_datedepthsiteelevationBroad_scale_environmental_contextLocal_scale_environmental_contextEnvironmental_mediumLatitude_and_LongitudeGeographic.LocationStudy_zoneEcological_typeParametrosTemperaturaSalinidadpHRedox.mVS.2SO4seasonfilter2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] \"1] Min. number of reads = 3581\"\n\n[[2]]\n[1] \"2] Max. number of reads = 150431\"\n\n[[3]]\n[1] \"3] Total number of reads = 1926306\"\n\n[[4]]\n[1] \"4] Average number of reads = 77052.24\"\n\n[[5]]\n[1] \"5] Median number of reads = 78367\"\n\n[[6]]\n[1] \"7] Sparsity = 0.574266263237519\"\n\n[[7]]\n[1] \"6] Any OTU sum to 1 or less? YES\"\n\n[[8]]\n[1] \"8] Number of singletons = 84\"\n\n[[9]]\n[1] \"9] Percent of OTUs that are singletons \\n        (i.e. exactly one read detected across all samples)0\"\n\n[[10]]\n[1] \"10] Number of sample variables are: 25\"\n\n[[11]]\n [1] \"SampleID\"                          \"BioSample\"                        \n [3] \"ID\"                                \"SRA\"                              \n [5] \"SampleName\"                        \"Collection_date\"                  \n [7] \"depth\"                             \"site\"                             \n [9] \"elevation\"                         \"Broad_scale_environmental_context\"\n[11] \"Local_scale_environmental_context\" \"Environmental_medium\"             \n[13] \"Latitude_and_Longitude\"            \"Geographic.Location\"              \n[15] \"Study_zone\"                        \"Ecological_type\"                  \n[17] \"Parametros\"                        \"Temperatura\"                      \n[19] \"Salinidad\"                         \"pH\"                               \n[21] \"Redox.mV\"                          \"S.2\"                              \n[23] \"SO4\"                               \"season\"                           \n[25] \"filter\"                           \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# get sums\ntaxa_sums <- taxa_sums(physeq_qiime)\n# Identify ASVs with sum 0 present in all samples\nzero_taxa <- taxa_names(physeq_qiime)[taxa_sums == 0]\n# Remove ASVs with sum 0\nphyseq_qiime2 <- prune_taxa(!taxa_names(physeq_qiime) %in%\n                                zero_taxa, physeq_qiime)\n\n# Remove singletons\nphyseq_qiime3 <- filter_taxa(physeq_qiime2, function(x) sum(x) > 1, TRUE)\n```\n:::\n\n\n\n### 02.2 Rename mangrove system\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract metadata\nmetadata <- as(sample_data(physeq_qiime3), \"data.frame\")\n\n# Rename specific levels in the Mangrove system column\n#library(dplyr)\nmetadata <- metadata %>%\n  mutate(`Mangrove system` = case_when(\n    Study_zone == \"Rio San Pedro\" ~ \"San Pedro River\",\n    Study_zone == \"Laguna Cacahuate\" ~ \"Fossil Lagoon\",\n    Study_zone == \"Estero_pargo\" ~ \"Términos Lagoon\",\n    Study_zone == \"Celestún\" ~ \"Celestún Lagoon\",\n    TRUE ~ Study_zone))\n```\n:::\n\n\n\n### 02.3 Add mangrove type\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract sample_data\nsample_data_df <- as(sample_data(physeq_qiime3), \"data.frame\")\n\n# Join sample_data with metadata to add Mangrove system\nsample_data_df <- sample_data_df %>%\n  left_join(dplyr::select(metadata, SampleID, `Mangrove system`), by = \"SampleID\")\n\n# Create Mangrove_type\nsample_data_df <- sample_data_df %>%\n  mutate(Mangrove_type = case_when(\n    `Mangrove system` %in% c(\"Fossil Lagoon\", \"San Pedro River\") ~ \"Interior\",\n    `Mangrove system` %in% c(\"Celestún Lagoon\", \"Términos Lagoon\") ~ \"Coastal\",\n    TRUE ~ NA_character_\n  ))\n\n# add .fastq.gz to SampleID \nsample_data_df$SampleID <- gsub(\"_R1$\", \"_R1.fastq.gz\", sample_data_df$SampleID)\n\n# add rownames as SampleID\nrownames(sample_data_df) <- sample_data_df$SampleID\n\n# update sample_data in phyloseq object\nsample_data(physeq_qiime3) <- sample_data(sample_data_df)\n\n# check\ntail(sample_data(physeq_qiime3))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                   SampleID    BioSample  ID          SRA\nSRR9973332                       SRR9973332 SAMN12325037 Cel        TM5.8\nSRR9973344                       SRR9973344 SAMN12325034 Cel        TM5.5\nSRR9973347                       SRR9973347 SAMN12325033 Cel        TM5.4\nzr2502_14_R1.fastq.gz zr2502_14_R1.fastq.gz                E zr2502_14_R1\nzr2502_1_R1.fastq.gz   zr2502_1_R1.fastq.gz                E  zr2502_1_R1\nzr2502_37_R1.fastq.gz zr2502_37_R1.fastq.gz                E zr2502_37_R1\n                      SampleName Collection_date depth site elevation\nSRR9973332            SRS5272925      2018-10-04  0.15              3\nSRR9973344            SRS5272913      2018-10-04  0.15              3\nSRR9973347            SRS5272910      2018-10-04  0.15              3\nzr2502_14_R1.fastq.gz                 17/01/2018     5             NA\nzr2502_1_R1.fastq.gz                  17/01/2018     5             NA\nzr2502_37_R1.fastq.gz                 30/05/2018     5             NA\n                      Broad_scale_environmental_context\nSRR9973332                                ENVO:01000181\nSRR9973344                                ENVO:01000181\nSRR9973347                                ENVO:01000181\nzr2502_14_R1.fastq.gz                                  \nzr2502_1_R1.fastq.gz                                   \nzr2502_37_R1.fastq.gz                                  \n                      Local_scale_environmental_context Environmental_medium\nSRR9973332                                ENVO:00000057             sediment\nSRR9973344                                ENVO:00000057             sediment\nSRR9973347                                ENVO:00000057             sediment\nzr2502_14_R1.fastq.gz                                                       \nzr2502_1_R1.fastq.gz                                                        \nzr2502_37_R1.fastq.gz                                                       \n                      Latitude_and_Longitude Geographic.Location   Study_zone\nSRR9973332                   20.85 N 90.37 W      Mexico:Yucatan     Celestún\nSRR9973344                   20.85 N 90.37 W      Mexico:Yucatan     Celestún\nSRR9973347                   20.85 N 90.37 W      Mexico:Yucatan     Celestún\nzr2502_14_R1.fastq.gz                            Mexico:Campeche Estero_pargo\nzr2502_1_R1.fastq.gz                             Mexico:Campeche Estero_pargo\nzr2502_37_R1.fastq.gz                            Mexico:Campeche Estero_pargo\n                      Ecological_type Parametros Temperatura Salinidad pH\nSRR9973332                     Fringe         no          NA        NA NA\nSRR9973344                     Fringe         no          NA        NA NA\nSRR9973347                     Fringe         no          NA        NA NA\nzr2502_14_R1.fastq.gz          Fringe         no          NA        NA NA\nzr2502_1_R1.fastq.gz           Fringe         no          NA        NA NA\nzr2502_37_R1.fastq.gz          Fringe         no          NA        NA NA\n                      Redox.mV S.2 SO4 season filter Mangrove.system\nSRR9973332                  NA  NA  NA  flood     si Celestún Lagoon\nSRR9973344                  NA  NA  NA  flood     si Celestún Lagoon\nSRR9973347                  NA  NA  NA  flood     si Celestún Lagoon\nzr2502_14_R1.fastq.gz       NA  NA  NA  flood     si Términos Lagoon\nzr2502_1_R1.fastq.gz        NA  NA  NA  flood     si Términos Lagoon\nzr2502_37_R1.fastq.gz       NA  NA  NA  flood     si Términos Lagoon\n                      Mangrove_type\nSRR9973332                  Coastal\nSRR9973344                  Coastal\nSRR9973347                  Coastal\nzr2502_14_R1.fastq.gz       Coastal\nzr2502_1_R1.fastq.gz        Coastal\nzr2502_37_R1.fastq.gz       Coastal\n```\n\n\n:::\n:::\n\n\n\n### 02.4 Create color pallete\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Mangrove system colors\nloc_colors <- c(\"Fossil Lagoon\"= \"#A7fcc1\",\n                \"San Pedro River\" = \"#26B170\",\n                \"Términos Lagoon\" = \"#329D9C\",\n                \"Celestún Lagoon\" = \"#41e8d3\")\n\n#Mangrove type colors\nmt_colors <- c(\"Interior\"= \"#A7fcc1\",\n                \"Coastal\" = \"#41e8d3\")\n```\n:::\n\n\n\n### 02.5 Check samples\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Samples Plot\nmetadata <- as(sample_data(physeq_qiime3), \"data.frame\")\n\nsamples_plot <- ggplot(metadata, aes(x = Mangrove.system, y = ..count..,\nfill = Mangrove.system)) + geom_bar(position = \"dodge\") +\n  facet_wrap(~ Mangrove_type, scales = \"free_x\") +\n  labs(title = \"Samples of the analysis\", y = \"Number of Samples\",\n       x = \"Mangrove system\") +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 0)) +\n  scale_fill_manual(values = loc_colors)\n\n# show plot\nprint(samples_plot)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The dot-dot notation (`..count..`) was deprecated in ggplot2 3.4.0.\nℹ Please use `after_stat(count)` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](02.SurfaceComparison_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n### 02.6 Save objects in RDS to next analysis\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(physeq_qiime3, \"rds/compare_mangroves/physeq_qiime3.rds\")\n```\n:::\n",
    "supporting": [
      "02.SurfaceComparison_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}