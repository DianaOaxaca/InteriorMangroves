{
  "hash": "de1bce065d3292baa3042152b08468f1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Core microbiome\"\n---\n\n\n\n\n## Load libraries and prepare data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load libraries\nlibrary(phyloseq)\nlibrary(dplyr)\nlibrary(UpSetR)\nlibrary(ggplot2)\nlibrary(ggalluvial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#load data\nphyseq_qiime3 <- readRDS(\"rds/compare_mangroves/physeq_qiime3.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Rename mangrove system columna\ncolnames(sample_data(physeq_qiime3))[colnames(sample_data(physeq_qiime3)) == \"Mangrove system\"] <- \"Mangrove_system\"\n\n# Convert Mangrove_system to factor\nsample_data(physeq_qiime3)$Mangrove_system <- as.factor(sample_data(physeq_qiime3)$Mangrove_system)\n```\n:::\n\n\n\n\n## 01. Calculate core\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prevalence threshold\nprevalence_threshold <- 0.8\n\n# Storage ASVs core list\ncore_list <- list()\nlocations <- levels(sample_data(physeq_qiime3)$Mangrove_system)\n\n# Calculate core\nfor (loc in locations) {\n  # Filter samples by mangrove system\n  physeq_loc <- prune_samples(sample_data(physeq_qiime3)$Mangrove_system == loc, physeq_qiime3)\n  n_samples_loc <- nsamples(physeq_loc)\n\n  # Extract OTU table\n  otu <- as(otu_table(physeq_loc), \"matrix\")\n\n  # Calc prevalence\n  prevalence <- rowSums(otu > 0) / n_samples_loc\n\n  # Identify ASVs with prevalence >= umbral\n  core_taxa <- names(prevalence)[prevalence >= prevalence_threshold]\n\n  # Guardar en la lista\n  core_list[[loc]] <- core_taxa\n}\n\n# Show ASVs core by mangrove system\nprint(lapply(core_list, length))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$`Celestún Lagoon`\n[1] 577\n\n$`Fossil Lagoon`\n[1] 745\n\n$`San Pedro River`\n[1] 781\n\n$`Términos Lagoon`\n[1] 16\n```\n\n\n:::\n\n```{.r .cell-code}\n# checkpoint,if empty try threshold = 1\nif (all(sapply(core_list, length) == 0)) {\n  cat(\"Try prevalence = 1...\\n\")\n  prevalence_threshold <- 1.0\n  core_list <- list()\n  for (loc in locations) {\n    physeq_loc <- prune_samples(sample_data(physeq_qiime3)$Mangrove_system == loc, physeq_qiime3)\n    n_samples_loc <- nsamples(physeq_loc)\n    otu <- as(otu_table(physeq_loc), \"matrix\")\n    prevalence <- rowSums(otu > 0) / n_samples_loc\n    core_taxa <- names(prevalence)[prevalence >= prevalence_threshold]\n    core_list[[loc]] <- core_taxa\n  }\n  print(lapply(core_list, length))\n}\n```\n:::\n\n\n\n\n## 02. Extract core info\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Unique core ASV list\nall_core_asvs <- unique(unlist(core_list))\n\n# Create matrix presence/absence\ncore_matrix <- matrix(0, nrow = length(all_core_asvs), ncol = length(locations),\n                      dimnames = list(all_core_asvs, locations))\n\n# fill matrix: \nfor (loc in locations) {\n  core_matrix[core_list[[loc]], loc] <- 1\n}\n\n# Convert to data frame to UpSetR\ncore_df <- as.data.frame(core_matrix)\n\n# Create intersection list\nqueries_list <- list()\n```\n:::\n\n\n\n\n## 03. plot aesthetics\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(UpSetR)\n# Fossil Lagoon\nqueries_list <- append(queries_list, list(\n  list(query = intersects, params = list(\"Fossil Lagoon\"), color = \"#A7FCC1\",\n       active = TRUE, query.name = \"Fossil Lagoon\")\n))\n\n# San Pedro River\nqueries_list <- append(queries_list, list(\n  list(query = intersects, params = list(\"San Pedro River\"), color = \"#26B170\",\n       active = TRUE, query.name = \"San Pedro River\")\n))\n\n# Terminos Lagoon\nqueries_list <- append(queries_list, list(\n  list(query = intersects, params = list(\"Términos Lagoon\"), color = \"#329D9C\",\n       active = TRUE, query.name = \"Términos Lagoon\")\n))\n\n# Celestún\nqueries_list <- append(queries_list, list(\n  list(query = intersects, params = list(\"Celestún Lagoon\"), color = \"#41E8D3\",\n       active = TRUE, query.name = \"Celestún Lagoon\")\n))\n\n# Core\nqueries_list <- append(queries_list, list(\n  list(query = intersects, params = list(\"Fossil Lagoon\", \n                                         \"San Pedro River\",\n                                         \"Términos Lagoon\",\n                                         \"Celestún Lagoon\"),\n       color = \"#8D3CA3\", active = TRUE, query.name = \"Core\")))\n\n# Interior\nqueries_list <- append(queries_list, list(\n  list(query = intersects, params = list(\"Fossil Lagoon\", \"San Pedro River\"),\n       color = \"#356E48\", active = TRUE, query.name = \"Interior\")\n))\n\n## Note: due to the fact that there were no unique asvs for coastal, it was not integrated in this selection.\n```\n:::\n\n\n\n\n## 04. UpSet plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(UpSetR)\nupset_plot <- upset(core_df,\n                    sets = colnames(core_df),\n                    order.by = \"freq\",\n                    mainbar.y.label = \"Shared ASVs\",\n                    sets.x.label = \"ASVs per Site\",\n                    text.scale = 1.5,\n                    point.size = 4,\n                    line.size = 1.5,\n                    query.legend = \"bottom\",\n                    sets.bar.color = \n                      c(\"#26B170\",\"#A7FCC1\",\"#41E8D3\",\"#329D9C\"),\n                    queries = queries_list)\n\n# show\nprint(upset_plot)\n```\n\n::: {.cell-output-display}\n![](02.3.Coremicrobiome_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\nsave plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npdf(\"Figures/SurfaceComparison/core_upset.pdf\", width = 5.8, height = 4)\nupset_plot\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nquartz_off_screen \n                2 \n```\n\n\n:::\n:::\n\n\n\n\n## 05. Get unique and core ASV info\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### get unique ASVs per mangrove system\nunique_asvs <- list()\nfor (loc in colnames(core_df)) {\n  unique_asvs[[loc]] <- rownames(core_df)[rowSums(core_df == 1) == 1 & core_df[[loc]] == 1]\n  cat(loc, \": Unique ASVs:\", length(unique_asvs[[loc]]), \"\\n\")\n  print(head(unique_asvs[[loc]], 5))  # Show first 5\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCelestún Lagoon : Unique ASVs: 186 \n[1] \"KU578729.1.1383\" \"JF344529.1.1525\" \"JN483938.1.1414\" \"HE804536.1.1436\"\n[5] \"DQ811792.1.1512\"\nFossil Lagoon : Unique ASVs: 270 \n[1] \"FN398053.1.1489\" \"FR667789.1.1446\" \"EU385876.1.1464\" \"EU487871.1.1472\"\n[5] \"JQ989640.1.1399\"\nSan Pedro River : Unique ASVs: 256 \n[1] \"KY618740.1.1206\" \"EU592483.1.1535\" \"LN567307.1.1331\" \"DQ363844.1.926\" \n[5] \"HM598151.1.1526\"\nTérminos Lagoon : Unique ASVs: 1 \n[1] \"EU487913.1.1482\"\n```\n\n\n:::\n\n```{.r .cell-code}\n#unique_asvs\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Verify taxonomy\nif (!is.null(tax_table(physeq_qiime3))) {\n  tax_table_df <- as.data.frame(tax_table(physeq_qiime3))\n\n  # Get taxonomy function\n  get_taxonomy <- function(asv_list) {\n    if (length(asv_list) > 0) {\n      taxonomy <- tax_table_df[asv_list, , drop = FALSE]\n      return(taxonomy)\n    } else {\n      return(NULL)\n    }\n  }\n\n  # Get taxonomy\n  taxonomy_unique <- lapply(unique_asvs, get_taxonomy)\n\n  # show first 5  unique ASVs\n  for (loc in names(taxonomy_unique)) {\n    cat(\"\\nFirst unique ASVs taxonomy\", loc, \":\\n\")\n    if (!is.null(taxonomy_unique[[loc]])) {\n      print(head(taxonomy_unique[[loc]], 5))\n    } else {\n      cat(\"There are no unique ASV to\", loc, \"\\n\")\n    }\n  }\n} else {\n  cat(\"Please import taxonomy.\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFirst unique ASVs taxonomy Celestún Lagoon :\n                    Kingdom                       Phylum\nKU578729.1.1383 d__Bacteria            Verrucomicrobiota\nJF344529.1.1525 d__Bacteria                      Sva0485\nJN483938.1.1414 d__Bacteria                 Bacteroidota\nHE804536.1.1436 d__Bacteria             Actinobacteriota\nDQ811792.1.1512 d__Bacteria SAR324_clade(Marine_group_B)\n                                       Class                        Order\nKU578729.1.1383                  Omnitrophia                Omnitrophales\nJF344529.1.1525                      Sva0485                      Sva0485\nJN483938.1.1414                  Bacteroidia                 Cytophagales\nHE804536.1.1436               Coriobacteriia                        OPB41\nDQ811792.1.1512 SAR324_clade(Marine_group_B) SAR324_clade(Marine_group_B)\n                                      Family                        Genus\nKU578729.1.1383               Omnitrophaceae       Candidatus_Omnitrophus\nJF344529.1.1525                      Sva0485                      Sva0485\nJN483938.1.1414            Cyclobacteriaceae                   uncultured\nHE804536.1.1436                        OPB41                        OPB41\nDQ811792.1.1512 SAR324_clade(Marine_group_B) SAR324_clade(Marine_group_B)\n                         Species\nKU578729.1.1383             <NA>\nJF344529.1.1525             <NA>\nJN483938.1.1414             <NA>\nHE804536.1.1436             <NA>\nDQ811792.1.1512 uncultured_delta\n\nFirst unique ASVs taxonomy Fossil Lagoon :\n                    Kingdom           Phylum               Class\nFN398053.1.1489 d__Bacteria   Proteobacteria Gammaproteobacteria\nFR667789.1.1446 d__Bacteria   Proteobacteria Alphaproteobacteria\nEU385876.1.1464 d__Bacteria   Proteobacteria Gammaproteobacteria\nEU487871.1.1472 d__Bacteria      Chloroflexi     Dehalococcoidia\nJQ989640.1.1399  d__Archaea Thermoplasmatota      Thermoplasmata\n                                             Order\nFN398053.1.1489                    Cellvibrionales\nFR667789.1.1446                      Micropepsales\nEU385876.1.1464              UBA10353_marine_group\nEU487871.1.1472                       Napoli-4B-65\nJQ989640.1.1399 Marine_Benthic_Group_D_and_DHVEG-1\n                                            Family\nFN398053.1.1489                         Halieaceae\nFR667789.1.1446                     Micropepsaceae\nEU385876.1.1464              UBA10353_marine_group\nEU487871.1.1472                       Napoli-4B-65\nJQ989640.1.1399 Marine_Benthic_Group_D_and_DHVEG-1\n                                             Genus              Species\nFN398053.1.1489                               <NA>                 <NA>\nFR667789.1.1446                     Micropepsaceae uncultured_bacterium\nEU385876.1.1464              UBA10353_marine_group uncultured_bacterium\nEU487871.1.1472                       Napoli-4B-65 uncultured_bacterium\nJQ989640.1.1399 Marine_Benthic_Group_D_and_DHVEG-1  uncultured_archaeon\n\nFirst unique ASVs taxonomy San Pedro River :\n                    Kingdom           Phylum               Class\nKY618740.1.1206 d__Bacteria       Firmicutes             Bacilli\nEU592483.1.1535 d__Bacteria Desulfobacterota     Desulfobacteria\nLN567307.1.1331 d__Bacteria   Proteobacteria Alphaproteobacteria\nDQ363844.1.926   d__Archaea Thermoplasmatota      Thermoplasmata\nHM598151.1.1526 d__Bacteria Desulfobacterota     Desulfobacteria\n                             Order              Family          Genus\nKY618740.1.1206         Bacillales         Bacillaceae       Bacillus\nEU592483.1.1535 Desulfatiglandales Desulfatiglandaceae Desulfatiglans\nLN567307.1.1331        Rhizobiales  Methyloligellaceae     uncultured\nDQ363844.1.926          uncultured          uncultured     uncultured\nHM598151.1.1526 Desulfatiglandales Desulfatiglandaceae Desulfatiglans\n                             Species\nKY618740.1.1206                 <NA>\nEU592483.1.1535 uncultured_bacterium\nLN567307.1.1331                 <NA>\nDQ363844.1.926   uncultured_archaeon\nHM598151.1.1526                 <NA>\n\nFirst unique ASVs taxonomy Términos Lagoon :\n                    Kingdom      Phylum        Class          Order\nEU487913.1.1482 d__Bacteria Chloroflexi Anaerolineae Anaerolineales\n                         Family      Genus Species\nEU487913.1.1482 Anaerolineaceae uncultured    <NA>\n```\n\n\n:::\n\n```{.r .cell-code}\n# Confirm the total number of unique ASVs\nlapply(taxonomy_unique, function(x) if (!is.null(x)) nrow(x) else 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$`Celestún Lagoon`\n[1] 186\n\n$`Fossil Lagoon`\n[1] 270\n\n$`San Pedro River`\n[1] 256\n\n$`Términos Lagoon`\n[1] 1\n```\n\n\n:::\n:::\n\n\n\n\nGet taxonomy\n\nPhylum level\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a list to store unique asv to Phylum level\nphylum_unique <- list()\n\n# Iterate on each Mangrove system\nfor (loc in names(taxonomy_unique)) {\n  if (!is.null(taxonomy_unique[[loc]])) {\n    # Extract taxonomy phylum\n    tax_df <- taxonomy_unique[[loc]]\n    if (\"Phylum\" %in% colnames(tax_df)) {\n      phylum <- tax_df$Phylum\n      phylum <- phylum[!is.na(phylum)]  # Exclude NA\n      phylum_unique[[loc]] <- unique(phylum)\n    } else {\n      cat(\"Phylum is not available to\", loc, \"\\n\")\n      phylum_unique[[loc]] <- character(0)\n    }\n  } else {\n    phylum_unique[[loc]] <- character(0)\n  }\n}\n\n# Identify exclusive phylum for Mangrove system\nall_phylums <- unique(unlist(phylum_unique))\nphylum_exclusive <- list()\nfor (loc in names(phylum_unique)) {\n  other_locations <- setdiff(names(phylum_unique), loc)\n  other_phylum <- unique(unlist(phylum_unique[other_locations]))\n  exclusive_phylum <- setdiff(phylum_unique[[loc]], other_phylum)\n  phylum_exclusive[[loc]] <- exclusive_phylum\n  cat(\"Exclusive phylum in\", loc, \":\", length(exclusive_phylum), \"\\n\")\n  if (length(exclusive_phylum) > 0) {\n    print(exclusive_phylum)\n  } else {\n    cat(\"There are not exclusive phylum.\\n\")\n  }\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nExclusive phylum in Celestún Lagoon : 5 \n[1] \"SAR324_clade(Marine_group_B)\" \"RCP2-54\"                     \n[3] \"Caldatribacteriota\"           \"CK-2C2-2\"                    \n[5] \"Nitrospinota\"                \nExclusive phylum in Fossil Lagoon : 12 \n [1] \"Patescibacteria\" \"Modulibacteria\"  \"Elusimicrobiota\" \"Halobacterota\"  \n [5] \"PAUC34f\"         \"Micrarchaeota\"   \"Hydrogenedentes\" \"LCP-89\"         \n [9] \"Cyanobacteria\"   \"Armatimonadota\"  \"Dependentiae\"    \"Acetothermia\"   \nExclusive phylum in San Pedro River : 3 \n[1] \"Dadabacteria\"     \"Abditibacteriota\" \"Sumerlaeota\"     \nExclusive phylum in Términos Lagoon : 0 \nThere are not exclusive phylum.\n```\n\n\n:::\n:::\n\n\n\n\nFamily level\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a list to store unique asv to specific taxonomy level\nfamilies_unique <- list()\n\n# Iterate on each Mangrove system\nfor (loc in names(taxonomy_unique)) {\n  if (!is.null(taxonomy_unique[[loc]])) {\n    # Extract taxonomy families\n    tax_df <- taxonomy_unique[[loc]]\n    if (\"Family\" %in% colnames(tax_df)) {\n      families <- tax_df$Family\n      families <- families[!is.na(families)]  # Exclude NA\n      families_unique[[loc]] <- unique(families)\n    } else {\n      cat(\"Family is not available to\", loc, \"\\n\")\n      families_unique[[loc]] <- character(0)\n    }\n  } else {\n    families_unique[[loc]] <- character(0)\n  }\n}\n\n# Identify exclusive family for Mangrove system\nall_families <- unique(unlist(families_unique))\nfamilies_exclusive <- list()\nfor (loc in names(families_unique)) {\n  other_locations <- setdiff(names(families_unique), loc)\n  other_families <- unique(unlist(families_unique[other_locations]))\n  exclusive_families <- setdiff(families_unique[[loc]], other_families)\n  families_exclusive[[loc]] <- exclusive_families\n  cat(\"Exclusive family in\", loc, \":\", length(exclusive_families), \"\\n\")\n  if (length(exclusive_families) > 0) {\n    print(exclusive_families)\n  } else {\n    cat(\"There are not exclusive family.\\n\")\n  }\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nExclusive family in Celestún Lagoon : 26 \n [1] \"OPB41\"                        \"SAR324_clade(Marine_group_B)\"\n [3] \"Hungateiclostridiaceae\"       \"MBAE14\"                      \n [5] \"RCP2-54\"                      \"Odinarchaeia\"                \n [7] \"Subgroup_9\"                   \"Nitrosomonadaceae\"           \n [9] \"EF100-94H03\"                  \"Desulfomonilaceae\"           \n[11] \"CCM11a\"                       \"FW22\"                        \n[13] \"JS1\"                          \"Microbulbiferaceae\"          \n[15] \"Ectothiorhodospiraceae\"       \"TG3\"                         \n[17] \"B2M28\"                        \"Caldilineaceae\"              \n[19] \"Nitrososphaeraceae\"           \"Subgroup_21\"                 \n[21] \"Gaiellaceae\"                  \"CK-2C2-2\"                    \n[23] \"Rhizobiales_Incertae_Sedis\"   \"Geothermarchaeaceae\"         \n[25] \"PS-B29\"                       \"P9X2b3D02\"                   \nExclusive family in Fossil Lagoon : 44 \n [1] \"Micropepsaceae\"          \"UBA10353_marine_group\"  \n [3] \"Bdellovibrionaceae\"      \"Gracilibacteria\"        \n [5] \"Moduliflexaceae\"         \"Lineage_IIc\"            \n [7] \"SM23-30\"                 \"Methanomicrobiaceae\"    \n [9] \"PAUC34f\"                 \"Nitrincolaceae\"         \n[11] \"MidBa8\"                  \"PAUC26f\"                \n[13] \"Bradymonadales\"          \"Solimonadaceae\"         \n[15] \"Simkaniaceae\"            \"67-14\"                  \n[17] \"vadinHA49\"               \"Micrarchaeales\"         \n[19] \"HOC36\"                   \"Melioribacteraceae\"     \n[21] \"Hydrogenedensaceae\"      \"Pla3_lineage\"           \n[23] \"LCP-89\"                  \"Rhodobacteraceae\"       \n[25] \"Micavibrionales\"         \"Desulfobacteraceae\"     \n[27] \"Pseudohongiellaceae\"     \"Nostocaceae\"            \n[29] \"VHS-B4-70\"               \"Dissulfuribacteraceae\"  \n[31] \"Run-SP154\"               \"Blastocatellaceae\"      \n[33] \"VHS-B3-70\"               \"Methylohalobiaceae\"     \n[35] \"SBYC\"                    \"Desulfovibrionaceae\"    \n[37] \"Vermiphilaceae\"          \"Kineosporiaceae\"        \n[39] \"Bacteroidetes_vadinHA17\" \"Syntrophobacteraceae\"   \n[41] \"Acetothermiia\"           \"Lentimicrobiaceae\"      \n[43] \"Haloadaptaceae\"          \"MD2894-B20\"             \nExclusive family in San Pedro River : 38 \n [1] \"Geopsychrobacteraceae\"  \"OM182_clade\"            \"Balneolaceae\"          \n [4] \"Subgroup_17\"            \"Sulfurovaceae\"          \"Dadabacteriales\"       \n [7] \"A4b\"                    \"Abditibacteriaceae\"     \"bacteriap25\"           \n[10] \"Marine_Benthic_Group_A\" \"t0.6.f\"                 \"Rhodospirillaceae\"     \n[13] \"Clostridiaceae\"         \"Thermoplasmata\"         \"Saccharospirillaceae\"  \n[16] \"Subgroup_2\"             \"DG-20\"                  \"Spongiibacteraceae\"    \n[19] \"Pla1_lineage\"           \"Desulfococcaceae\"       \"Thiomicrospiraceae\"    \n[22] \"Emcibacteraceae\"        \"Eel-36e1D6\"             \"Thermoplasmatota\"      \n[25] \"Sumerlaeaceae\"          \"KI89A_clade\"            \"PHOS-HE36\"             \n[28] \"Desulfurivibrionaceae\"  \"Planococcaceae\"         \"Hyphomonadaceae\"       \n[31] \"Colwelliaceae\"          \"SAR202_clade\"           \"Arcobacteraceae\"       \n[34] \"Thiotrichaceae\"         \"Myxococcaceae\"          \"C86\"                   \n[37] \"AB-539-J10\"             \"Bacteriovoracaceae\"    \nExclusive family in Términos Lagoon : 0 \nThere are not exclusive family.\n```\n\n\n:::\n:::\n\n\n\n\nGet core table\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Combine taxonomy in data.frame\ntaxonomy_unique_df <- do.call(rbind, lapply(names(taxonomy_unique), function(loc) {\n  if (!is.null(taxonomy_unique[[loc]])) {\n    df <- taxonomy_unique[[loc]]\n    df$Location <- loc\n    df$ASV <- rownames(df)# add name asv column\n    return(df)\n  } else {\n    return(NULL)\n  }\n}))\n\n# Move columns\ntaxonomy_unique_df <- taxonomy_unique_df[, c(\"ASV\", \"Location\", setdiff(names(taxonomy_unique_df), c(\"ASV\", \"Location\")))]\n\n# show first rows of data.frame to verify\nprint(head(taxonomy_unique_df))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                            ASV        Location     Kingdom\nKU578729.1.1383 KU578729.1.1383 Celestún Lagoon d__Bacteria\nJF344529.1.1525 JF344529.1.1525 Celestún Lagoon d__Bacteria\nJN483938.1.1414 JN483938.1.1414 Celestún Lagoon d__Bacteria\nHE804536.1.1436 HE804536.1.1436 Celestún Lagoon d__Bacteria\nDQ811792.1.1512 DQ811792.1.1512 Celestún Lagoon d__Bacteria\nAF354161.1.1421 AF354161.1.1421 Celestún Lagoon d__Bacteria\n                                      Phylum                        Class\nKU578729.1.1383            Verrucomicrobiota                  Omnitrophia\nJF344529.1.1525                      Sva0485                      Sva0485\nJN483938.1.1414                 Bacteroidota                  Bacteroidia\nHE804536.1.1436             Actinobacteriota               Coriobacteriia\nDQ811792.1.1512 SAR324_clade(Marine_group_B) SAR324_clade(Marine_group_B)\nAF354161.1.1421                Calditrichota                 Calditrichia\n                                       Order                       Family\nKU578729.1.1383                Omnitrophales               Omnitrophaceae\nJF344529.1.1525                      Sva0485                      Sva0485\nJN483938.1.1414                 Cytophagales            Cyclobacteriaceae\nHE804536.1.1436                        OPB41                        OPB41\nDQ811792.1.1512 SAR324_clade(Marine_group_B) SAR324_clade(Marine_group_B)\nAF354161.1.1421               Calditrichales              Calditrichaceae\n                                       Genus          Species\nKU578729.1.1383       Candidatus_Omnitrophus             <NA>\nJF344529.1.1525                      Sva0485             <NA>\nJN483938.1.1414                   uncultured             <NA>\nHE804536.1.1436                        OPB41             <NA>\nDQ811792.1.1512 SAR324_clade(Marine_group_B) uncultured_delta\nAF354161.1.1421              Calditrichaceae             <NA>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# save data.frame\nwrite.csv(taxonomy_unique_df, file = \"Tables/SurfaceComparison/unique_asvs_taxonomy.csv\", row.names = FALSE)\n```\n:::\n\n\n\n\n## 06. Get core taxonomy\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nshared_asvs <- Reduce(intersect, core_list)\nprint(shared_asvs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"DQ811808.1.1527\" \"EU652571.1.1503\" \"GQ249585.1.1531\" \"AM176885.1.1418\"\n[5] \"FJ203391.1.1488\" \"FJ712534.1.1514\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nshared_taxonomy <- get_taxonomy(shared_asvs)\nprint(shared_taxonomy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                    Kingdom           Phylum               Class\nDQ811808.1.1527 d__Bacteria           MBNT15              MBNT15\nEU652571.1.1503 d__Bacteria   Proteobacteria Gammaproteobacteria\nGQ249585.1.1531 d__Bacteria Desulfobacterota     Desulfobacteria\nAM176885.1.1418 d__Bacteria   Proteobacteria Alphaproteobacteria\nFJ203391.1.1488 d__Bacteria            NB1-j               NB1-j\nFJ712534.1.1514 d__Bacteria    Calditrichota        Calditrichia\n                            Order             Family           Genus\nDQ811808.1.1527            MBNT15             MBNT15          MBNT15\nEU652571.1.1503   Nitrosococcales   Nitrosococcaceae            AqS1\nGQ249585.1.1531 Desulfobacterales Desulfosarcinaceae            <NA>\nAM176885.1.1418        uncultured         uncultured      uncultured\nFJ203391.1.1488             NB1-j              NB1-j           NB1-j\nFJ712534.1.1514    Calditrichales    Calditrichaceae Calditrichaceae\n                                        Species\nDQ811808.1.1527 uncultured_Syntrophobacteraceae\nEU652571.1.1503            uncultured_bacterium\nGQ249585.1.1531                            <NA>\nAM176885.1.1418     uncultured_Rhodobacteraceae\nFJ203391.1.1488                            <NA>\nFJ712534.1.1514                            <NA>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nshared_family <- unique(shared_taxonomy$Family[!is.na(shared_taxonomy$Family)])\nprint(shared_family)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"MBNT15\"             \"Nitrosococcaceae\"   \"Desulfosarcinaceae\"\n[4] \"uncultured\"         \"NB1-j\"              \"Calditrichaceae\"   \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nshared_phyla <- unique(shared_taxonomy$Phylum[!is.na(shared_taxonomy$Phylum)])\nprint(shared_phyla)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"MBNT15\"           \"Proteobacteria\"   \"Desulfobacterota\" \"NB1-j\"           \n[5] \"Calditrichota\"   \n```\n\n\n:::\n:::\n\n\n\n\n## 07. Relative abundance of core asv\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter\nphyseq_shared <- prune_taxa(shared_asvs, physeq_qiime3)\notu_table(physeq_shared)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOTU Table:          [6 taxa and 25 samples]\n                     taxa are rows\n                S1A015 S1B07 S2B07 S3A07 S4B07 S5A07 S5B07 S6A07 S6B07 S7A07\nDQ811808.1.1527    115   194    59   108    72   216   140    57   182    80\nEU652571.1.1503   5951 12881  5260  8577  6118 13519  8852  6312 11648  5638\nGQ249585.1.1531     67    75    33    19   283    23   112   231   217   284\nAM176885.1.1418    348   658   261   463   292   762   513   402   861   372\nFJ203391.1.1488      2    38    43    16    44    21    51    67     7    72\nFJ712534.1.1514    189    72    32     7   213   114    95   543   365   489\n                S7B07 SRR9973320 SRR9973321 SRR9973322 SRR9973323 SRR9973324\nDQ811808.1.1527    70        853        734        163          7        704\nEU652571.1.1503  5563        397        834         42          8        443\nGQ249585.1.1531   305        214        341        367         23        425\nAM176885.1.1418   270          9         22         13          4         90\nFJ203391.1.1488    28         24         16         13          0         11\nFJ712534.1.1514   380          8         29         12        152          8\n                SRR9973326 SRR9973327 SRR9973331 SRR9973332 SRR9973344\nDQ811808.1.1527        218        345        326        117       1206\nEU652571.1.1503        133        127         58          0        571\nGQ249585.1.1531        122        616        611         37        567\nAM176885.1.1418         34         61         43         17         16\nFJ203391.1.1488          4          8          7          2          9\nFJ712534.1.1514          4         18         42         14         24\n                SRR9973347 zr2502_14_R1.fastq.gz zr2502_1_R1.fastq.gz\nDQ811808.1.1527       1375                   354                   13\nEU652571.1.1503        565                    33                  205\nGQ249585.1.1531        522                    23                   33\nAM176885.1.1418        161                   109                   39\nFJ203391.1.1488         14                    10                   29\nFJ712534.1.1514         54                    28                   72\n                zr2502_37_R1.fastq.gz\nDQ811808.1.1527                   343\nEU652571.1.1503                   286\nGQ249585.1.1531                    16\nAM176885.1.1418                    31\nFJ203391.1.1488                    19\nFJ712534.1.1514                    58\n```\n\n\n:::\n\n```{.r .cell-code}\n# rel abundance\nphyseq_rel <- transform_sample_counts(physeq_shared, function(x){x / sum(x)})\notu_table(physeq_shared)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOTU Table:          [6 taxa and 25 samples]\n                     taxa are rows\n                S1A015 S1B07 S2B07 S3A07 S4B07 S5A07 S5B07 S6A07 S6B07 S7A07\nDQ811808.1.1527    115   194    59   108    72   216   140    57   182    80\nEU652571.1.1503   5951 12881  5260  8577  6118 13519  8852  6312 11648  5638\nGQ249585.1.1531     67    75    33    19   283    23   112   231   217   284\nAM176885.1.1418    348   658   261   463   292   762   513   402   861   372\nFJ203391.1.1488      2    38    43    16    44    21    51    67     7    72\nFJ712534.1.1514    189    72    32     7   213   114    95   543   365   489\n                S7B07 SRR9973320 SRR9973321 SRR9973322 SRR9973323 SRR9973324\nDQ811808.1.1527    70        853        734        163          7        704\nEU652571.1.1503  5563        397        834         42          8        443\nGQ249585.1.1531   305        214        341        367         23        425\nAM176885.1.1418   270          9         22         13          4         90\nFJ203391.1.1488    28         24         16         13          0         11\nFJ712534.1.1514   380          8         29         12        152          8\n                SRR9973326 SRR9973327 SRR9973331 SRR9973332 SRR9973344\nDQ811808.1.1527        218        345        326        117       1206\nEU652571.1.1503        133        127         58          0        571\nGQ249585.1.1531        122        616        611         37        567\nAM176885.1.1418         34         61         43         17         16\nFJ203391.1.1488          4          8          7          2          9\nFJ712534.1.1514          4         18         42         14         24\n                SRR9973347 zr2502_14_R1.fastq.gz zr2502_1_R1.fastq.gz\nDQ811808.1.1527       1375                   354                   13\nEU652571.1.1503        565                    33                  205\nGQ249585.1.1531        522                    23                   33\nAM176885.1.1418        161                   109                   39\nFJ203391.1.1488         14                    10                   29\nFJ712534.1.1514         54                    28                   72\n                zr2502_37_R1.fastq.gz\nDQ811808.1.1527                   343\nEU652571.1.1503                   286\nGQ249585.1.1531                    16\nAM176885.1.1418                    31\nFJ203391.1.1488                    19\nFJ712534.1.1514                    58\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregate data by Mangrove_system\nphyseq_agg <- merge_samples(physeq_rel, \"Mangrove_system\")\n\n# Convert to relative abundance\nphyseq_agg_rel <- transform_sample_counts(physeq_agg, function(x) x / sum(x))\n\n# Map Mangrove_type back as a simple vector\nsample_data(physeq_agg_rel)$Mangrove_type <- unlist(sapply(sample_names(physeq_agg_rel), function(sys) {\n  unique(sample_data(physeq_rel)[sample_data(physeq_rel)$Mangrove_system == sys, \"Mangrove_type\"])[1]\n}))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create the bar plot with facet by Mangrove_type\nbarplot_core <- phyloseq::plot_bar(physeq_agg_rel, fill = \"Family\") +\n    geom_bar(aes(color = Family, fill = Family), stat = \"identity\", position = \"stack\") +\n    labs(x = \"\", y = \"Relative Abundance\", element_text(size = 9)) +\n    facet_wrap(~ Mangrove_type, scales = \"free_x\", nrow = 1) +\n    scale_fill_manual(values = c(\"#2B0082\", \"#54278F\", \"#724BB1\", \"#706AF5\", \"#706BB1\", \"#BCBDDC\", \"#DADAEB\")) +\n    scale_color_manual(values = c(\"#2B0082\", \"#54278F\", \"#724BB1\", \"#706AF5\", \"#706BB1\", \"#BCBDDC\", \"#DADAEB\")) +\n  theme(axis.text = element_text(colour = \"black\", size = 10),\n        axis.title = element_text(colour = \"black\", size = 10),\n        legend.text = element_text(size = 9),\n        legend.title = element_text(size = 10),\n        axis.text.x = element_text(size = 9, angle = 0, \n                        hjust = 0.5, color = \"black\"),\n      axis.text.y = element_text(size = 9, color = \"black\"),\n      #strip.background = element_blank(),\n      panel.background = element_blank())\n\nbarplot_core\n```\n\n::: {.cell-output-display}\n![](02.3.Coremicrobiome_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npdf(\"Figures/SurfaceComparison/rel_abun_core.pdf\")\nbarplot_core\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nquartz_off_screen \n                2 \n```\n\n\n:::\n:::\n\n\n\n\n## Save rds core plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(upset_plot, \"rds/compare_mangroves/upset_surface_plot.rds\")\n```\n:::\n",
    "supporting": [
      "02.3.Coremicrobiome_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}