{
  "hash": "076870d0fdd54a69f0eb54cee27846f5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Differential Abundance\"\n---\n\n\n\n\n# Load libraries and prepare data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load libraries\nlibrary(phyloseq)\nlibrary(dplyr)\nlibrary(ANCOMBC)\nlibrary(tidyverse)\nlibrary(cowplot)\nlibrary(DT)\noptions(DT.options = list(\n  initComplete = JS(\"function(settings, json) {\",\n                    \"$(this.api().table().header()).css({'background-color':\n  '#000', 'color': '#fff'});\",\"}\")))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#load data\nps <- readRDS(\"rds/interior_mangroves/phyloseq.rds\")\n```\n:::\n\n\n\n\n# **Differential abundance ANCOMBC2**\n\n## 01. By Depth\n\n### **01.1 Prepare data**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# phyloseq to TreeSummarizedExperiment\ntse <- mia::convertFromPhyloseq(ps)\n\n# contrast matrix\ncontrast_matrices <- list(\n  matrix(c(1, -1, 0,\n           0, 1, -1,\n           0, 0, 1),\n         nrow = 3, byrow = TRUE),\n  matrix(c(1, 0, -1,\n           0, 1, -1,\n           0, 0, 1),\n         nrow = 3, byrow = TRUE),\n  matrix(c(1, 0, 0,\n           0, 1, -1,\n           0, 0, 1),\n         nrow = 3, byrow = TRUE),\n  matrix(c(1, -1, 0,\n           0, 1, 0,\n           0, 0, 1),\n         nrow = 3, byrow = TRUE))\n\n# nodes\nnodes <- list(1, 1, 1, 1)\n```\n:::\n\n\n\n\n### 01.2 Run ANCOM-BC2\n\n``` R\n# ANCOMBC2\noutput <- ancombc2(\n  data = tse,\n  assay_name = \"counts\",\n  tax_level = \"Phylum\",\n  fix_formula = \"Location + Depth_cm\",\n  rand_formula = \"(1 | ID)\",\n  p_adj_method = \"holm\",\n  pseudo_sens = TRUE,\n  prv_cut = 0.10,\n  lib_cut = 1000,\n  s0_perc = 0.05,\n  group = \"Depth_cm\",\n  struc_zero = TRUE,\n  neg_lb = TRUE,\n  alpha = 0.05,\n  n_cl = 2,\n  verbose = TRUE,\n  global = TRUE,\n  pairwise = TRUE,\n  dunnet = TRUE,\n  trend = TRUE,\n  iter_control = list(tol = 1e-2, max_iter = 20, verbose = TRUE),\n  em_control = list(tol = 1e-5, max_iter = 100),\n  lme_control = lme4::lmerControl(),\n  mdfdr_control = list(fwer_ctrl_method = \"holm\", B = 100),\n  trend_control = list(\n    contrast = contrast_matrices,\n    node = nodes,\n    solver = \"ECOS\",\n    B = 100))\n```\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#See results\nres_pair <- output$res_pair\n\nhead(res_pair)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n              taxon lfc_Depth_cm16-30 lfc_Depth_cm31-45 lfc_Depth_cm50-75\n1    Proteobacteria           -0.2127            -0.196            -0.337\n2       Chloroflexi            1.0161             1.094             1.482\n3  Latescibacterota           -0.0353            -0.348            -0.782\n4       Myxococcota           -0.0741            -0.477            -0.737\n5      Zixibacteria            0.6524             0.567             0.886\n6 Methylomirabilota           -0.2690            -0.977            -1.240\n  lfc_Depth_cm31-45_Depth_cm16-30 lfc_Depth_cm50-75_Depth_cm16-30\n1                          0.0164                          -0.124\n2                          0.0774                           0.465\n3                         -0.3130                          -0.747\n4                         -0.4030                          -0.663\n5                         -0.0857                           0.234\n6                         -0.7075                          -0.971\n  lfc_Depth_cm50-75_Depth_cm31-45 se_Depth_cm16-30 se_Depth_cm31-45\n1                          -0.140            0.246            0.245\n2                           0.388            0.186            0.184\n3                          -0.434            0.233            0.232\n4                          -0.260            0.232            0.231\n5                           0.320            0.214            0.212\n6                          -0.263            0.288            0.286\n  se_Depth_cm50-75 se_Depth_cm31-45_Depth_cm16-30\n1            0.256                          0.276\n2            0.194                          0.223\n3            0.244                          0.265\n4            0.243                          0.263\n5            0.223                          0.247\n6            0.310                          0.314\n  se_Depth_cm50-75_Depth_cm16-30 se_Depth_cm50-75_Depth_cm31-45 W_Depth_cm16-30\n1                          0.286                          0.285          -0.864\n2                          0.231                          0.230           5.474\n3                          0.275                          0.274          -0.151\n4                          0.274                          0.273          -0.319\n5                          0.256                          0.255           3.055\n6                          0.336                          0.335          -0.935\n  W_Depth_cm31-45 W_Depth_cm50-75 W_Depth_cm31-45_Depth_cm16-30\n1          -0.802           -1.31                        0.0594\n2           5.937            7.65                        0.3476\n3          -1.501           -3.20                       -1.1833\n4          -2.069           -3.04                       -1.5306\n5           2.671            3.98                       -0.3471\n6          -3.412           -4.00                       -2.2538\n  W_Depth_cm50-75_Depth_cm16-30 W_Depth_cm50-75_Depth_cm31-45 p_Depth_cm16-30\n1                        -0.433                        -0.492        1.00e+00\n2                         2.017                         1.690        4.13e-06\n3                        -2.714                        -1.583        8.81e-01\n4                        -2.422                        -0.955        7.51e-01\n5                         0.913                         1.253        4.35e-03\n6                        -2.891                        -0.787        3.56e-01\n  p_Depth_cm31-45 p_Depth_cm50-75 p_Depth_cm31-45_Depth_cm16-30\n1        1.00e+00        1.00e+00                         1.000\n2        1.03e-06        6.59e-09                         0.730\n3        1.42e-01        2.90e-03                         0.245\n4        4.62e-02        4.49e-03                         0.135\n5        1.15e-02        3.41e-04                         0.731\n6        1.73e-03        3.35e-04                         0.031\n  p_Depth_cm50-75_Depth_cm16-30 p_Depth_cm50-75_Depth_cm31-45 q_Depth_cm16-30\n1                       1.00000                         1.000        1.00e+00\n2                       0.05159                         0.100        3.63e-05\n3                       0.01033                         0.122        1.00e+00\n4                       0.02085                         0.346        1.00e+00\n5                       0.36788                         0.219        4.26e-02\n6                       0.00674                         0.437        1.00e+00\n  q_Depth_cm31-45 q_Depth_cm50-75 q_Depth_cm31-45_Depth_cm16-30\n1        1.00e+00        1.00e+00                         1.000\n2        1.01e-05        7.12e-08                         1.000\n3        1.00e+00        3.14e-02                         1.000\n4        4.06e-01        4.84e-02                         1.000\n5        1.01e-01        3.68e-03                         1.000\n6        1.69e-02        3.62e-03                         0.242\n  q_Depth_cm50-75_Depth_cm16-30 q_Depth_cm50-75_Depth_cm31-45\n1                        1.0000                         1.000\n2                        0.4024                         0.681\n3                        0.1012                         1.000\n4                        0.2043                         1.000\n5                        1.0000                         1.000\n6                        0.0594                         1.000\n  diff_Depth_cm16-30 diff_Depth_cm31-45 diff_Depth_cm50-75\n1              FALSE              FALSE              FALSE\n2               TRUE               TRUE               TRUE\n3              FALSE              FALSE               TRUE\n4              FALSE              FALSE               TRUE\n5               TRUE              FALSE               TRUE\n6              FALSE               TRUE               TRUE\n  diff_Depth_cm31-45_Depth_cm16-30 diff_Depth_cm50-75_Depth_cm16-30\n1                            FALSE                            FALSE\n2                            FALSE                            FALSE\n3                            FALSE                            FALSE\n4                            FALSE                            FALSE\n5                            FALSE                            FALSE\n6                            FALSE                            FALSE\n  diff_Depth_cm50-75_Depth_cm31-45 passed_ss_Depth_cm16-30\n1                            FALSE                    TRUE\n2                            FALSE                    TRUE\n3                            FALSE                    TRUE\n4                            FALSE                    TRUE\n5                            FALSE                    TRUE\n6                            FALSE                    TRUE\n  passed_ss_Depth_cm31-45 passed_ss_Depth_cm50-75\n1                    TRUE                    TRUE\n2                    TRUE                    TRUE\n3                    TRUE                    TRUE\n4                    TRUE                    TRUE\n5                   FALSE                    TRUE\n6                   FALSE                    TRUE\n  passed_ss_Depth_cm31-45_Depth_cm16-30 passed_ss_Depth_cm50-75_Depth_cm16-30\n1                                  TRUE                                  TRUE\n2                                  TRUE                                  TRUE\n3                                  TRUE                                 FALSE\n4                                  TRUE                                 FALSE\n5                                  TRUE                                  TRUE\n6                                  TRUE                                 FALSE\n  passed_ss_Depth_cm50-75_Depth_cm31-45\n1                                  TRUE\n2                                  TRUE\n3                                  TRUE\n4                                  TRUE\n5                                  TRUE\n6                                  TRUE\n```\n\n\n:::\n:::\n\n\n\n\n### 01.3 Get differential data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create dataframe df_fig_pair1 to log-fold change (LFC) values\ndf_fig_pair1 <- res_pair %>%\n  dplyr::filter(`diff_Depth_cm16-30` == 1 |\n                  `diff_Depth_cm31-45` == 1 |\n                  `diff_Depth_cm50-75` == 1 |\n                  `diff_Depth_cm31-45_Depth_cm16-30` == 1 |\n                  `diff_Depth_cm50-75_Depth_cm16-30` == 1 |\n                  `diff_Depth_cm50-75_Depth_cm31-45` == 1) %>%\n  dplyr::mutate(lfc1 = ifelse(`diff_Depth_cm16-30` == 1, round(`lfc_Depth_cm16-30`, 2), NA),\n                lfc2 = ifelse(`diff_Depth_cm31-45` == 1, round(`lfc_Depth_cm31-45`, 2), NA),\n                lfc3 = ifelse(`diff_Depth_cm50-75` == 1, round(`lfc_Depth_cm50-75`, 2), NA),\n                lfc4 = ifelse(`diff_Depth_cm31-45_Depth_cm16-30` == 1, \n                      round(`lfc_Depth_cm31-45_Depth_cm16-30`, 2), NA),\n                lfc5 = ifelse(`diff_Depth_cm50-75_Depth_cm16-30` == 1, \n                      round(`lfc_Depth_cm50-75_Depth_cm16-30`, 2), NA),\n                lfc6 = ifelse(`diff_Depth_cm50-75_Depth_cm31-45` == 1, \n                      round(`lfc_Depth_cm50-75_Depth_cm31-45`, 2), NA)) %>%\n  tidyr::pivot_longer(cols = lfc1:lfc6, names_to = \"group\", \n                      values_to = \"value\") %>% dplyr::arrange(taxon)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create dataframe df_fig_pair2 to significant values\n\ndf_fig_pair2 <- res_pair %>%\n  dplyr::filter(`diff_Depth_cm16-30` == 1 |\n                  `diff_Depth_cm31-45` == 1 |\n                  `diff_Depth_cm50-75` == 1 |\n                  `diff_Depth_cm31-45_Depth_cm16-30` == 1 |\n                  `diff_Depth_cm50-75_Depth_cm16-30` == 1 |\n                  `diff_Depth_cm50-75_Depth_cm31-45` == 1) %>%\n  dplyr::mutate(lfc1 = ifelse(`passed_ss_Depth_cm16-30` == 1 & `diff_Depth_cm16-30` == 1, \"darkblue\", \"black\"),\n                lfc2 = ifelse(`passed_ss_Depth_cm31-45` == 1 & `diff_Depth_cm31-45` == 1, \"darkblue\", \"black\"),\n                lfc3 = ifelse(`passed_ss_Depth_cm50-75` == 1 & `diff_Depth_cm50-75` == 1, \"darkblue\", \"black\"),\n                lfc4 = ifelse(`passed_ss_Depth_cm31-45_Depth_cm16-30` == 1 & `diff_Depth_cm31-45_Depth_cm16-30` == 1, \"darkblue\", \"black\"),\n                lfc5 = ifelse(`passed_ss_Depth_cm50-75_Depth_cm16-30` == 1 & `diff_Depth_cm50-75_Depth_cm16-30` == 1, \"darkblue\", \"black\"),\n                lfc6 = ifelse(`passed_ss_Depth_cm50-75_Depth_cm31-45` == 1 & `diff_Depth_cm50-75_Depth_cm31-45` == 1, \"darkblue\", \"black\")) %>%\n  tidyr::pivot_longer(cols = lfc1:lfc6, names_to = \"group\", values_to = \"color\") %>%\n  dplyr::arrange(taxon)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Combine dataframes df_fig_pair1 and df_fig_pair2\ndf_fig_pair <- df_fig_pair1 %>%\n  dplyr::left_join(df_fig_pair2, by = c(\"taxon\", \"group\"))\n\n# Rename groups\ndf_fig_pair$group <- recode(df_fig_pair$group,\n                            `lfc1` = \"16-30 vs 0-15\",\n                            `lfc2` = \"31-45 vs 0-15\",\n                            `lfc3` = \"50-75 vs 0-15\",\n                            `lfc4` = \"31-45 vs 16-30\",\n                            `lfc5` = \"50-75 vs 16-30\",\n                            `lfc6` = \"50-75 vs 31-45\")\n\ndf_fig_pair$group <- factor(df_fig_pair$group,\n                            levels = c(\"16-30 vs 0-15\",\n                                       \"31-45 vs 0-15\",\n                                       \"50-75 vs 0-15\",\n                                       \"31-45 vs 16-30\",\n                                       \"50-75 vs 16-30\",\n                                       \"50-75 vs 31-45\"))\n\n# Filter comparisons with significant values\ndf_fig_pair <- df_fig_pair %>%\n  group_by(group) %>%\n  filter(any(!is.na(value))) %>%\n  ungroup()\n\n# Calculate limits\nlo <- floor(min(df_fig_pair$value, na.rm = TRUE))\nup <- ceiling(max(df_fig_pair$value, na.rm = TRUE))\nmid <- (lo + up) / 2\n```\n:::\n\n\n\n\n### 01.4 Heatmap Plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_pair <- df_fig_pair %>%\n  ggplot(aes(x = group, y = taxon, fill = value)) +\n  geom_tile(color = \"gray40\") +\n  scale_fill_gradient2(low = \"#c05098\", high = \"#3FB6AFFF\", mid = \"gray90\",\n                       na.value = \"white\", midpoint = mid, \n                       limit = c(lo, up),name = \"LFC\") +\n  geom_text(aes(label = round(value, 2), color = color), \n            size = 3.5, na.rm = TRUE) + \n  scale_color_identity(guide = FALSE) +\n  labs(x = NULL, y = NULL) + theme_classic() +\n  theme(plot.title = element_text(hjust = 0.5, size = 12),\n        axis.text.y = element_text(size = 12, color = \"black\"),\n        axis.text.x = element_text(size = 10, color = \"black\"))\n\nfig_pair\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `guide` argument in `scale_*()` cannot be `FALSE`. This was deprecated in\nggplot2 3.3.4.\nâ„¹ Please use \"none\" instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](03.5.DifferentialAbundance_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n### 01.5 Relative abundance of differential Phyla\n\n#### 01.5.1 Filter and prepare data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter da phyla\ndifferential_phyla <- c(\"Zixibacteria\", \"WS2\", \"uncultured\",\n                        \"Thermoplasmatota\", \"TA06\", \"Sva0485\",\n                        \"Spirochaetota\", \"RCP2-54\", \"Nitrospinota\", \n                        \"NB1-j\", \"Myxococcota\", \"Modulibacteria\", \n                        \"Methylomirabilota\", \"MBNT15\", \"LCP-89\",\n                        \"Latescibacterota\", \"Fibrobacterota\", \n                        \"Crenarchaeota\", \"Chloroflexi\", \n                        \"Calditrichota\", \"Armatimonadota\")\n\n# Filter in phyloseq\nps_da <- subset_taxa(ps, Phylum %in% differential_phyla)\n\n# Depth aggregation\nps_da_agg <- merge_samples(ps_da, \"Depths\")\n\n# relative abundance\nps_da_agg_rel <- transform_sample_counts(ps_da_agg, function(x) x / sum(x))\n\n# check value and names Depths\ndepths <- unique(sample_data(ps)$Depths)\nsample_names(ps_da_agg_rel) <- depths\nsample_data(ps_da_agg_rel)$Depths <- factor(depths, levels = depths)\n\n# Convert to data frame\ndf_abundance <- psmelt(ps_da_agg_rel)\n\n# summary by depth and phylum\ndf_abundance_summary <- df_abundance %>%\n  group_by(Phylum, Depths) %>%\n  summarise(Abundance = mean(Abundance, na.rm = TRUE)) %>%\n  ungroup()\n\n# Replace NA with 0\ndf_abundance_summary$Abundance[is.na(df_abundance_summary$Abundance)] <- 0\n```\n:::\n\n\n\n\n#### 01.5.2 Bubble plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define colors\ndepth_colors <- c(\"0-15\" = \"#f5e5c4\",\n                  \"16-30\" = \"#baa179\",\n                  \"31-45\" = \"#a67451\",\n                  \"50-75\" = \"#80673b\")\n\n# bubble plot\nbubble_plot <- ggplot(df_abundance_summary, \n                      aes(x = Depths, y = Phylum, size = Abundance,\n                          fill = Depths)) +\n  geom_point(shape = 21, color = \"gray40\") +\n  scale_size_continuous(range = c(1, 12), guide = \"none\") +\n  scale_fill_manual(values = depth_colors) +\n  labs(y = NULL, x=NULL , fill = NULL) +\n  theme_classic() +\n  theme(\n    axis.text.x = element_text(angle = 0, hjust = 0.5, \n                               size = 8.5, color = \"black\"),\n    axis.text.y = element_text(size = 12, color = \"black\"),\n    legend.position = \"none\")\n\n# show\nbubble_plot\n```\n\n::: {.cell-output-display}\n![](03.5.DifferentialAbundance_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n### 01.6 Join relative and differential abundance plots\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig_pair <- fig_pair +\n  theme(\n    axis.text.y = element_blank(),\n    axis.text.x = element_text(size = 8.5 , color = \"black\"),\n    axis.line.y = element_blank(),\n    axis.line.x = element_line(color = \"black\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndepth_abundances <- plot_grid(bubble_plot, fig_pair, ncol = 2, rel_widths = c(0.95, 1.1))\n\ndepth_abundances\n```\n\n::: {.cell-output-display}\n![](03.5.DifferentialAbundance_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# save\nggsave(\"Figures/interior_mangroves/DA_and_RA_BubbleHeatmap_depth.pdf\",\n       depth_abundances, bg='transparent', \n       width = 6.7, height = 8)\n```\n:::\n\n\n\n\n### 01.7 Save RDS plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(depth_abundances, \"rds/interior_mangroves/da_ra_depth_plot.rds\")\n```\n:::\n",
    "supporting": [
      "03.5.DifferentialAbundance_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}