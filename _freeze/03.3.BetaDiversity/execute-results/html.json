{
  "hash": "afe6bc0803a999d52495075bf7e53726",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Beta diversity\"\n---\n\n\n\n\n\n# Load libraries and prepare data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Load libraries\nlibrary(vegan)\nlibrary(phyloseq)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(tidyverse)\nlibrary(pairwiseAdonis)\nlibrary(reshape2)\nlibrary(ggpubr)\nlibrary(cowplot)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#load data\nps <- readRDS(\"rds/interior_mangroves/phyloseq.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract data from phyloseq object\n#library(phyloseq)\notu_data <- otu_table(ps, taxa_are_rows = TRUE)\nmetadata <- as(sample_data(ps), \"data.frame\")\nsample_data <- data.frame(sample_data(ps))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# color pallet\ndepth_colors <- c(\"0-15\" = \"#f5e5c4\",\n                 \"16-30\" = \"#baa179\",\n                 \"31-45\" = \"#a67451\",\n                 \"50-75\" = \"#80673b\")\n\nloc_colors <- c(\"Fossil Lagoon\"= \"#A3D9A8\",\n                \"Reforma Waterfalls\" = \"#44C17B\",\n                \"Miguelito Dike\" = \"#2E8B57\")\n```\n:::\n\n\n\n\n\n# 01. Weighted Unifrac\n\n## 01.1 All samples\n\n### 01.1.1 Get distances and stress\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# NMDS wu\nset.seed(123)\nnmds_wunifrac <- ordinate(ps, method = \"NMDS\", distance = \"wunifrac\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRun 0 stress 0.0887 \nRun 1 stress 0.135 \nRun 2 stress 0.0924 \nRun 3 stress 0.0924 \nRun 4 stress 0.0887 \n... New best solution\n... Procrustes: rmse 6.43e-05  max resid 0.000367 \n... Similar to previous best\nRun 5 stress 0.0943 \nRun 6 stress 0.0924 \nRun 7 stress 0.116 \nRun 8 stress 0.0967 \nRun 9 stress 0.0943 \nRun 10 stress 0.121 \nRun 11 stress 0.0943 \nRun 12 stress 0.0924 \nRun 13 stress 0.117 \nRun 14 stress 0.0941 \nRun 15 stress 0.0941 \nRun 16 stress 0.0887 \n... Procrustes: rmse 0.00011  max resid 0.000666 \n... Similar to previous best\nRun 17 stress 0.0887 \n... Procrustes: rmse 6.31e-05  max resid 0.000392 \n... Similar to previous best\nRun 18 stress 0.0887 \n... Procrustes: rmse 6.78e-05  max resid 0.000404 \n... Similar to previous best\nRun 19 stress 0.0887 \n... Procrustes: rmse 3.66e-05  max resid 2e-04 \n... Similar to previous best\nRun 20 stress 0.0887 \n... New best solution\n... Procrustes: rmse 5.51e-05  max resid 0.000327 \n... Similar to previous best\n*** Best solution repeated 1 times\n```\n\n\n:::\n\n```{.r .cell-code}\n# stress variable\nvar_stress_nmds_wu <- round(nmds_wunifrac$stress, 5)\nvar_stress_nmds_wu\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.0887\n```\n\n\n:::\n:::\n\n\n\n\n\n### 01.1.2 Plot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert Depth to factor \nsample_data(ps)$Depths <- factor(sample_data(ps)$Depths, levels = c(\"0-15\", \"16-30\", \"31-45\", \"50-75\"))\n\n#plot\nnmds_wu <- plot_ordination(ps, nmds_wunifrac, color = \"Depths\") + theme_classic() + \n  labs(col = \"Depth\") + \n  labs(title=\"Weighted UniFrac\") +\n  geom_point(size=5) +\n    scale_fill_manual(values = depth_colors)+ \n    scale_color_manual(values = depth_colors)\n\nnmds_wu <- nmds_wu +\n  annotate(\"text\", x = Inf, y = -Inf, label = paste(\"Stress:\", var_stress_nmds_wu),\n           hjust = 1.1, vjust = -1.1, size = 4)\n\n#show\nnmds_wu\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### 01.1.3 PERMANOVA\n\n::: callout-note\nTo test the effects of Depth and Location on the Weighted Unifrac dissimilarity, a PERMANOVA analysis was conducted using adonis2.\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# UniFrac\nwunifrac_distances <- UniFrac(ps, weighted = TRUE)\n\n# Convert distances 'dist' class\nwunifrac_distances <- as.dist(wunifrac_distances)\n\n# PERMANOVA \nset.seed(123)\nadonis2_wunifrac <- adonis2(\n  wunifrac_distances ~ Depths + Location,\n  data = metadata,\n  permutations = 999,\n  strata = metadata$ID,\n  by = \"terms\")\n\n# Results\nperm_results <- data.frame(\n  Term = c(\"Depth_cm\", \"Location\", \"Residual\"),\n  R2 = c(adonis2_wunifrac$R2[1], adonis2_wunifrac$R2[2], adonis2_wunifrac$R2[3]),\n  p_value = c(adonis2_wunifrac$`Pr(>F)`[1], adonis2_wunifrac$`Pr(>F)`[2], NA))\n\nperm_results\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Term    R2 p_value\n1 Depth_cm 0.226   0.001\n2 Location 0.182   0.002\n3 Residual 0.592      NA\n```\n\n\n:::\n\n```{.r .cell-code}\n# PERMANOVA text\nperm_text <- paste(\n  \"PERMANOVA:\",\n  paste(\"Depths: R² =\", round(perm_results$R2[1], 3), \", p =\", perm_results$p_value[1]),\n  paste(\"Location: R² =\", round(perm_results$R2[2], 3), \", p =\", perm_results$p_value[2]),\n  paste(\"Residual: R² =\", round(perm_results$R2[3], 3)),\n  sep = \"\\n\")\n```\n:::\n\n\n\n\n\n### 01.1.4 Plot with permanova\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add to plot\nnmds_wu <- nmds_wu +\n  annotate(\n    \"text\", x = Inf, y = Inf, label = perm_text,\n    hjust = 1.1, vjust = 1.6, size = 3, color = \"black\"\n  )\n\n# Mostrar el gráfico\nnmds_wu\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/nmds_wunifrac_all.pdf\", nmds_wu, width = 20, height = 15, units = \"cm\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: No shared levels found between `names(values)` of the manual scale and the\ndata's fill values.\n```\n\n\n:::\n:::\n\n\n\n\n\n## 01.2 Surface and deep samples\n\n### 01.2.1 Filter depths\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter data 0-15 y 50-75\nsample_data(ps)$Depths_fltr <- factor(sample_data(ps)$Depths, levels = c(\"0-15\", \"50-75\"))\n\nps_fltr <- prune_samples(sample_data(ps)$Depths_fltr %in% c(\"0-15\", \"50-75\"), ps)\n\nmetadata_fltr <- as(sample_data(ps_fltr), \"data.frame\")\n```\n:::\n\n\n\n\n\n### 01.2.2 Get distances and stress\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Distances\nset.seed(123)\nnmds_wunifrac_fltr <- ordinate(ps_fltr, method = \"NMDS\", distance = \"wunifrac\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRun 0 stress 0.0614 \nRun 1 stress 0.0614 \n... Procrustes: rmse 1.38e-05  max resid 4.53e-05 \n... Similar to previous best\nRun 2 stress 0.0614 \n... Procrustes: rmse 1.04e-05  max resid 4.14e-05 \n... Similar to previous best\nRun 3 stress 0.0728 \nRun 4 stress 0.0728 \nRun 5 stress 0.0728 \nRun 6 stress 0.0614 \n... Procrustes: rmse 2e-05  max resid 7.56e-05 \n... Similar to previous best\nRun 7 stress 0.0879 \nRun 8 stress 0.0728 \nRun 9 stress 0.0879 \nRun 10 stress 0.0728 \nRun 11 stress 0.1 \nRun 12 stress 0.0614 \n... New best solution\n... Procrustes: rmse 2.65e-06  max resid 7.37e-06 \n... Similar to previous best\nRun 13 stress 0.0614 \n... Procrustes: rmse 2.63e-05  max resid 9.25e-05 \n... Similar to previous best\nRun 14 stress 0.0728 \nRun 15 stress 0.0614 \n... Procrustes: rmse 4.99e-05  max resid 0.000154 \n... Similar to previous best\nRun 16 stress 0.0614 \n... Procrustes: rmse 2.23e-05  max resid 8.27e-05 \n... Similar to previous best\nRun 17 stress 0.0728 \nRun 18 stress 0.0879 \nRun 19 stress 0.1 \nRun 20 stress 0.105 \n*** Best solution repeated 4 times\n```\n\n\n:::\n\n```{.r .cell-code}\n# stress\nvar_stress_nmds_wu_fltr <- round(nmds_wunifrac_fltr$stress, 5)\n```\n:::\n\n\n\n\n\n### 01.2.3 NMDS plot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot NMDS\nnmds_wu_fltr <- plot_ordination(ps_fltr, nmds_wunifrac_fltr, color = \"Depths\") + \n  theme_classic() + \n  labs(col = \"Depths\") + \n  labs(title = \"Weighted UniFrac\") +\n  geom_point(size = 5) +\n  scale_fill_manual(values = depth_colors) + \n  scale_color_manual(values = depth_colors)\n\n# add stress\nnmds_wu_fltr <- nmds_wu_fltr +\n  annotate(\"text\", x = Inf, y = -Inf, label = paste(\"Stress:\", var_stress_nmds_wu_fltr),\n           hjust = 1.1, vjust = -1.2, size = 3)\n```\n:::\n\n\n\n\n\n### 01.2.4 PERMANOVA\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# UniFrac distances\nwunifrac_distances_fltr <- UniFrac(ps_fltr, weighted = TRUE)\n\n# Convert 'dist' class\nwunifrac_distances_fltr <- as.dist(wunifrac_distances_fltr)\n\n# PERMANOVA \nset.seed(123)\nadonis2_wunifrac_fltr <- adonis2(\n  wunifrac_distances_fltr ~ Depths_fltr + Location,\n  data = metadata_fltr,\n  permutations = 999,\n  strata = metadata_fltr$ID,\n  by = \"terms\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSet of permutations < 'minperm'. Generating entire set.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Results\nperm_results_fltr <- data.frame(\n  Term = c(\"Depth_cm\", \"Location\", \"Residual\"),\n  R2 = c(adonis2_wunifrac_fltr$R2[1], adonis2_wunifrac_fltr$R2[2], adonis2_wunifrac_fltr$R2[3]),\n  p_value = c(adonis2_wunifrac_fltr$`Pr(>F)`[1], adonis2_wunifrac_fltr$`Pr(>F)`[2], NA))\n\nperm_results_fltr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Term     R2 p_value\n1 Depth_cm 0.3465   0.002\n2 Location 0.0932   0.157\n3 Residual 0.5604      NA\n```\n\n\n:::\n\n```{.r .cell-code}\n# PERMANOVA text\nperm_text_fltr <- paste(\n  \"PERMANOVA:\",\n  paste(\"Depths: R² =\", round(perm_results_fltr$R2[1], 3), \", p =\", perm_results_fltr$p_value[1]),\n  paste(\"Location: R² =\", round(perm_results_fltr$R2[2], 3), \", p =\", perm_results_fltr$p_value[2]), sep = \"\\n\")\n```\n:::\n\n\n\n\n\n### 01.2.5 Post-hoc adonis\n\n::: callout-note\nTo test differences between the Mangrove systems a Post-hoc pairwise PERMANOVA was conducted using pairwise.adonis\n:::\n\n### 01.2.6 Pairwise adonis\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Post-hoc Depths\n# Pairwise PERMANOVA  Weighted UniFrac\nset.seed(123)\npairwise_adonis_fltr <- pairwiseAdonis::pairwise.adonis2(\n  wunifrac_distances_fltr ~ Depths_fltr,\n  data = metadata_fltr,\n  permutations = 999)\n\n# show\npairwise_adonis_fltr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$parent_call\n[1] \"wunifrac_distances_fltr ~ Depths_fltr , strata = Null , permutations 999\"\n\n$`0-15_vs_50-75`\n         Df SumOfSqs    R2    F Pr(>F)    \nModel     1    0.237 0.346 11.7  0.001 ***\nResidual 22    0.447 0.654                \nTotal    23    0.685 1.000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nattr(,\"class\")\n[1] \"pwadstrata\" \"list\"      \n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract pairwise adonis results\npairwise_text_fltr <- paste(\n  \"Pairwise PERMANOVA Depths:\",\n  paste(\"R² =\", round(pairwise_adonis_fltr$`0-15_vs_50-75`$R2[1], 3), \n        \", p =\", pairwise_adonis_fltr$`0-15_vs_50-75`$`Pr(>F)`[1]),\n  sep = \"\\n\")\n```\n:::\n\n\n\n\n\n### 01.2.7 Beta disper\n\n::: callout-important\nGiven the pairwise PERMANOVA showed a highly significant result (p = 0.001), it is prudent to calculate the beta dispersion to validate that this result reflects real differences in microbial community composition between “0-15” and “50-75,” and not just differences in variability within each depth. In addition, R² = 0.346 indicates a moderate effect, but the 65.4% residual variance suggests unexplained variability, which could include differences in dispersion.\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Beta disp\nbeta_disp_fltr <- betadisper(wunifrac_distances_fltr, metadata_fltr$Depths_fltr)\n\n# Significant test\nanova_beta_disp_fltr <- anova(beta_disp_fltr)\nanova_beta_disp_fltr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Variance Table\n\nResponse: Distances\n          Df Sum Sq Mean Sq F value Pr(>F)\nGroups     1 0.0013 0.00129    0.35   0.56\nResiduals 22 0.0807 0.00367               \n```\n\n\n:::\n\n```{.r .cell-code}\n# Show dispersion by group\nbeta_disp_fltr$group.distances\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n 0-15 50-75 \n0.132 0.117 \n```\n\n\n:::\n\n```{.r .cell-code}\n# boxplot betadisper\nbeta_data_fltr <- data.frame(\n  Group = metadata_fltr$Depths_fltr,\n  Distance_to_centroid = beta_disp_fltr$distances\n)\nbeta_plot_fltr <- ggplot(beta_data_fltr, aes(x = Group, y = Distance_to_centroid, fill = Group)) +\n  geom_boxplot() +\n  scale_fill_manual(values = depth_colors) +\n  labs(title = \"Betadisper by depth wUniFrac\") +\n  theme_classic()\n\n#show\nbeta_plot_fltr\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\nSave boxplot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/Betadisper_depth.pdf\", beta_plot_fltr, bg='transparent', width = 4, height = 4.5)\n```\n:::\n\n\n\n\n\n### 01.2.8 Plot with PERMANOVA, pairwise PERMANOVA and Betadisper\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add betadisper p-value text\nbeta_text_fltr <- paste(\"Betadisper p-value:\", round(anova_beta_disp_fltr$`Pr(>F)`[1], 3))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Añadir texto de PERMANOVA y dispersión beta\nnmds_wu_fltr <- nmds_wu_fltr +\n  annotate(\n    \"text\", x = Inf, y = Inf, \n    label = paste(perm_text_fltr, pairwise_text_fltr, beta_text_fltr, sep = \"\\n\"),\n    hjust = 1.1, vjust = 1.2, size = 3, color = \"black\")\nnmds_wu_fltr\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\nsave\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/NMDS_wu_depth.pdf\", nmds_wu_fltr, bg='transparent', width = 6, height = 4.5)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: No shared levels found between `names(values)` of the manual scale and the\ndata's fill values.\n```\n\n\n:::\n:::\n\n\n\n\n\n# 02. Unweighted UniFrac\n\n## 02.1 Get distances and stress\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Unweighted UniFrac\nnmds_unifrac <- ordinate(ps, method = \"NMDS\", distance = \"unifrac\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRun 0 stress 0.0783 \nRun 1 stress 0.0783 \n... New best solution\n... Procrustes: rmse 0.000102  max resid 0.000654 \n... Similar to previous best\nRun 2 stress 0.0857 \nRun 3 stress 0.0976 \nRun 4 stress 0.0929 \nRun 5 stress 0.0941 \nRun 6 stress 0.0964 \nRun 7 stress 0.0999 \nRun 8 stress 0.403 \nRun 9 stress 0.112 \nRun 10 stress 0.0941 \nRun 11 stress 0.0999 \nRun 12 stress 0.0783 \n... Procrustes: rmse 0.000441  max resid 0.00284 \n... Similar to previous best\nRun 13 stress 0.0964 \nRun 14 stress 0.0929 \nRun 15 stress 0.0975 \nRun 16 stress 0.0783 \n... Procrustes: rmse 6.12e-05  max resid 0.000392 \n... Similar to previous best\nRun 17 stress 0.104 \nRun 18 stress 0.0783 \n... Procrustes: rmse 0.00053  max resid 0.00341 \n... Similar to previous best\nRun 19 stress 0.0857 \nRun 20 stress 0.1 \n*** Best solution repeated 4 times\n```\n\n\n:::\n\n```{.r .cell-code}\n# stress variable\nvar_stress_nmds_u <- round(nmds_unifrac$stress, 5)\nvar_stress_nmds_u\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.0783\n```\n\n\n:::\n:::\n\n\n\n\n\n## 02.2 NMDS\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Reorder 'Location'\nsample_data(ps)$Location <- factor(sample_data(ps)$Location, levels = c(\"Fossil Lagoon\", \"Reforma Waterfalls\", \"Miguelito Dike\"))\n\n# NMDS\nnmds_u <- plot_ordination(ps, nmds_unifrac, color = \"Location\") + \n  theme_classic() + \n  labs(col = \"Location\", title = \"Unweighted UniFrac\") +\n  geom_point(size = 5) +\n  scale_fill_manual(values = loc_colors) + \n  scale_color_manual(values = loc_colors) +\n  annotate(\"text\", x = Inf, y = -Inf, \n           label = paste(\"Stress:\", var_stress_nmds_u),\n           hjust = 1.1, vjust = -1.3, size = 3)\n```\n:::\n\n\n\n\n\n## 02.3 PERMANOVA\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# UniFrac distances\nunifrac_distances <- UniFrac(ps, weighted = FALSE)\n\n# Convert 'dist' class\nunifrac_distances <- as.dist(unifrac_distances)\n\n# PERMANOVA \nset.seed(123)\nadonis2_unifrac <- adonis2(\n  unifrac_distances ~ Location + Depths,\n  data = metadata,\n  permutations = 999,\n  strata = metadata$ID,\n  by = \"terms\")\n\n# Results\nperm_results <- data.frame(\n  Term = c(\"Location\",\"Depths\", \"Residual\"),\n  R2 = c(adonis2_unifrac$R2[1], adonis2_unifrac$R2[2], adonis2_unifrac$R2[3]),\n  p_value = c(adonis2_unifrac$`Pr(>F)`[1], adonis2_unifrac$`Pr(>F)`[2], NA))\n\nperm_results\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Term    R2 p_value\n1 Location 0.301   0.001\n2   Depths 0.136   0.001\n3 Residual 0.563      NA\n```\n\n\n:::\n\n```{.r .cell-code}\n# PERMANOVA text\nperm_text <- paste(\n  \"PERMANOVA:\",\n  paste(\"Location: R² =\", round(perm_results$R2[1], 3), \", p =\", perm_results$p_value[1]),\n  paste(\"Depths: R² =\", round(perm_results$R2[2], 3), \", p =\", perm_results$p_value[2]), sep = \"\\n\")\n```\n:::\n\n\n\n\n\n## 02.4 Post-hoc adonis\n\n::: callout-important\nTo test differences between the Mangrove systems a Post-hoc pairwise PERMANOVA was conducted using pairwise.adonis\n:::\n\n## 02.5 Pairwise adonis\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Post-hoc Location\n# Pairwise PERMANOVA  Weighted UniFrac\nset.seed(123)\npairwise_adonis_u <- pairwiseAdonis::pairwise.adonis2(\n  unifrac_distances ~ Location + Depths,\n  data = metadata,\n  permutations = 999)\n\n# show\npairwise_adonis_u\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$parent_call\n[1] \"unifrac_distances ~ Location + Depths , strata = Null , permutations 999\"\n\n$`Miguelito Dike_vs_Reforma Waterfalls`\n         Df SumOfSqs    R2    F Pr(>F)   \nModel     4     0.93 0.288 3.14  0.002 **\nResidual 31     2.30 0.712               \nTotal    35     3.23 1.000               \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`Miguelito Dike_vs_Fossil Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)    \nModel     4     1.60 0.411 5.75  0.001 ***\nResidual 33     2.29 0.589                \nTotal    37     3.89 1.000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`Reforma Waterfalls_vs_Fossil Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)    \nModel     4    1.148 0.599 7.86  0.001 ***\nResidual 21    0.767 0.401                \nTotal    25    1.915 1.000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nattr(,\"class\")\n[1] \"pwadstrata\" \"list\"      \n```\n\n\n:::\n:::\n\n\n\n\n\n## 02.6 Extract p-values\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define abbrevs\nlocation_abbrevs <- c(\n  \"Miguelito Dike\" = \"MD\",\n  \"Reforma Waterfalls\" = \"RW\",\n  \"Fossil Lagoon\" = \"FL\")\n\n# Extract values\nlocations <- unique(metadata$Location)\np_matrix <- matrix(NA, nrow = length(locations), ncol = length(locations),\n                   dimnames = list(locations, locations))\nr2_matrix <- matrix(NA, nrow = length(locations), ncol = length(locations),\n                    dimnames = list(locations, locations))\n\nfor (comp in names(pairwise_adonis_u)[-1]) {  # Exclude 'parent_call'\n  pair <- strsplit(comp, \"_vs_\")[[1]]\n  loc1 <- pair[1]\n  loc2 <- pair[2]\n  p_matrix[loc1, loc2] <- pairwise_adonis_u[[comp]]$`Pr(>F)`[1]\n  p_matrix[loc2, loc1] <- pairwise_adonis_u[[comp]]$`Pr(>F)`[1]  # Simetric\n  r2_matrix[loc1, loc2] <- pairwise_adonis_u[[comp]]$R2[1]\n  r2_matrix[loc2, loc1] <- pairwise_adonis_u[[comp]]$R2[1]  # Sim\n}\ndiag(p_matrix) <- 1  # p-value = 1 \ndiag(r2_matrix) <- 0  # R² = 0 \n\n# abbrevs in matrix\nabbrev_locations <- location_abbrevs[locations]\nnames(abbrev_locations) <- NULL\ndimnames(p_matrix) <- list(abbrev_locations, abbrev_locations)\ndimnames(r2_matrix) <- list(abbrev_locations, abbrev_locations)\n\n# Convert to long format\np_melt <- melt(p_matrix, na.rm = TRUE)\ncolnames(p_melt) <- c(\"Location1\", \"Location2\", \"p_value\")\nr2_melt <- melt(r2_matrix, na.rm = TRUE)\ncolnames(r2_melt) <- c(\"Location1\", \"Location2\", \"R2\")\n```\n:::\n\n\n\n\n\n## 02.7 Heatmap\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Heatmap of p-values\nheatmap_plot_p <- ggplot(p_melt, aes(x = Location1, y = Location2, fill = p_value)) +\n  geom_tile(color = \"gray40\") +\n  scale_fill_gradient2(low = \"white\", mid = \"white\", high = \"gray40\",\n                       midpoint = 0.025, limits = c(0, 1),\n                       name = \"p-value\") +\n  geom_text(aes(label = sprintf(\"%.3f\", p_value)), color = \"black\", size = 3) +\n  theme_minimal() +\n  labs(title = \"Pairwise PERMANOVA Unweighted UniFrac\", y = \"Location\") +\n  theme(axis.text.x = element_blank(),  # Ocult axis x\n        axis.title.x = element_blank(),\n        axis.title.y = element_text(size = 12),\n        plot.title = element_text(size = 12))\n\n# Heatmap de R²\nheatmap_plot_r2 <- ggplot(r2_melt, aes(x = Location1, y = Location2, fill = R2)) +\n  geom_tile(color = \"gray40\") +\n  scale_fill_gradient(low = \"white\", high = \"gray40\",\n                      name = \"R²\") +\n  geom_text(aes(label = sprintf(\"%.3f\", R2)), color = \"black\", size = 3) +\n  theme_minimal() +\n  labs(title = NULL,\n       x = \"Location\", y = \"Location\") +\n  theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 12),\n        axis.title = element_text(size = 12),\n        plot.title = element_text(size = 12))\n\n# join cowplot\ncombined_heatmap <- plot_grid(\n  heatmap_plot_p, heatmap_plot_r2,\n  nrow = 2, align = \"v\", axis = \"lr\"\n)\n\n# show\ncombined_heatmap\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n\n\n\nsave\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/pairwiseheatmap.pdf\", combined_heatmap, bg='transparent', width = 4, height = 4.5)\n```\n:::\n\n\n\n\n\n## 02.8 Beta disper\n\n::: callout-important\nGiven the pairwise PERMANOVA showed a highly significant results, it is prudent to calculate the beta dispersion to validate that this result reflects real differences in microbial community composition between mangrove location and not just differences in variability within mangrove site.\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Beta disp\nbeta_disp_u <- betadisper(unifrac_distances, metadata$Location)\nanova_beta_disp_u <- anova(beta_disp_u)\n\n# Show dispersion by group\nbeta_disp_u$group.distances\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     Fossil Lagoon     Miguelito Dike Reforma Waterfalls \n             0.216              0.270              0.231 \n```\n\n\n:::\n\n```{.r .cell-code}\n# boxplot betadisper\nbeta_data <- data.frame(\n  Group = metadata$Location,\n  Distance_to_centroid = beta_disp_u$distances\n)\nbeta_plot <- ggplot(beta_data, aes(x = Group, y = Distance_to_centroid, fill = Group)) +\n  geom_boxplot() +\n  scale_fill_manual(values = loc_colors) +\n  labs(title = \"Betadisper by location wUniFrac\") +\n  theme_classic()\n\n#show\nbeta_plot\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/Betadisper_location.pdf\", beta_plot, bg='transparent', width = 5.5, height = 4)\n```\n:::\n\n\n\n\n\n## 02.9 Plot with PERMANOVA, pairwise PERMANOVA and Betadisper\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_text <- paste(\"Betadisper, p-value:\", \n                   round(anova_beta_disp_u$`Pr(>F)`[1], 3))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add texts to NMDS\nnmds_u <- nmds_u +\n  annotate(\n    \"text\", x = Inf, y = Inf, \n    label = paste(perm_text, beta_text, sep = \"\\n\"),\n    hjust = 1.1, vjust = 1.2, size = 3, color = \"black\"\n  )\n```\n:::\n\n\n\n\n\nSave\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/NMDS_u_location.pdf\", nmds_u, bg='transparent', width = 6, height = 4.5)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: No shared levels found between `names(values)` of the manual scale and the\ndata's fill values.\n```\n\n\n:::\n:::\n\n\n\n\n\n# 03. dbRDA\n\n## 03.1 Load an prepare data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read data\nphychem <- read.csv(\"data/physicochemists.csv\", stringsAsFactors = FALSE)\n\n# Rename specific levels\nphychem <- phychem %>%\n  mutate(`Locality` = case_when(\n    Locality == \"El Cacahuate\" ~ \"Fossil Lagoon\",\n    Locality == \"La Piedad\" ~ \"Reforma Waterfalls\",\n    Locality == \"Dique Miguelito\" ~ \"Miguelito Dike\",\n    TRUE ~ Locality))\n\n# extract intersticial samples 30 cm\nps_phychem30cm <- prune_samples(sample_data(ps)$Depths == \"31-45\", ps)\n\n# Extract metadata from filter object\nmetadata_phychem30cm <- as.data.frame(sample_data(ps_phychem30cm))\n\n# convert to data frame\nmetadata_phychem30cm_df <- data.frame(as(sample_data(ps_phychem30cm), \n                                         \"data.frame\"))\n# join\ncombined_metadata <- merge(metadata_phychem30cm_df, phychem,\n                           by = \"Sample\", all.x = TRUE)\n\n# rownames\nrownames(combined_metadata) <- combined_metadata$Sample\n\n# Convert to sample_data\nsample_data_combined <- sample_data(combined_metadata)\n\n# save into phyloseq object\nsample_data(ps_phychem30cm) <- sample_data_combined\n```\n:::\n\n\n\n\n\n## 03.2 Get distances\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calcular las distancias Unifrac no ponderadas\nunifrac_distances_phychem30cm<- distance(ps_phychem30cm, method = \"unifrac\", weighted = FALSE)\n```\n:::\n\n\n\n\n\n## 03.3 Calculate dbRDA\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert distance matrix to vegdist object\nunifrac_vegdist_phychem30cm <- as.dist(unifrac_distances_phychem30cm)\n\n# db-RDA\ndbrda_result <- capscale(unifrac_vegdist_phychem30cm ~ Temperature...C. + \n                           Salinity..ppm. + pH + Redox.mV..Eh. + \n                           S.2..mg.l. + SO....mg.l., data = phychem)\n\n# summary\nsummary(dbrda_result)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\ncapscale(formula = unifrac_vegdist_phychem30cm ~ Temperature...C. +      Salinity..ppm. + pH + Redox.mV..Eh. + S.2..mg.l. + SO....mg.l.,      data = phychem) \n\nPartitioning of squared Unknown distance:\n              Inertia Proportion\nTotal           0.995      1.000\nConstrained     0.609      0.612\nUnconstrained   0.385      0.388\n\nEigenvalues, and their contribution to the squared Unknown distance \n\nImportance of components:\n                       CAP1  CAP2   CAP3   CAP4   CAP5   CAP6  MDS1   MDS2\nEigenvalue            0.324 0.117 0.0814 0.0403 0.0263 0.0207 0.261 0.0425\nProportion Explained  0.325 0.117 0.0818 0.0405 0.0265 0.0208 0.263 0.0427\nCumulative Proportion 0.325 0.443 0.5247 0.5652 0.5916 0.6124 0.875 0.9180\n                        MDS3   MDS4   MDS5   MDS6\nEigenvalue            0.0261 0.0242 0.0180 0.0133\nProportion Explained  0.0262 0.0244 0.0181 0.0134\nCumulative Proportion 0.9442 0.9685 0.9866 1.0000\n\nAccumulated constrained eigenvalues\nImportance of components:\n                       CAP1  CAP2   CAP3   CAP4   CAP5   CAP6\nEigenvalue            0.324 0.117 0.0814 0.0403 0.0263 0.0207\nProportion Explained  0.531 0.192 0.1336 0.0661 0.0432 0.0340\nCumulative Proportion 0.531 0.723 0.8567 0.9228 0.9660 1.0000\n```\n\n\n:::\n:::\n\n\n\n\n\n## 03.4 Get significance\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Significance\nanova_axes <- anova(dbrda_result, by = \"axis\", \n                    permutations = 999)\nanova_axes\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for capscale under reduced model\nForward tests for axes\nPermutation: free\nNumber of permutations: 999\n\nModel: capscale(formula = unifrac_vegdist_phychem30cm ~ Temperature...C. + Salinity..ppm. + pH + Redox.mV..Eh. + S.2..mg.l. + SO....mg.l., data = phychem)\n         Df SumOfSqs    F Pr(>F)\nCAP1      1    0.324 5.04   0.14\nCAP2      1    0.117 1.82   0.75\nCAP3      1    0.081 1.27   0.84\nCAP4      1    0.040 0.63   0.96\nCAP5      1    0.026 0.41   0.97\nCAP6      1    0.021 0.32   0.97\nResidual  6    0.385            \n```\n\n\n:::\n\n```{.r .cell-code}\n# Significance by variable\nanova_terms <- anova(dbrda_result, by = \"terms\", \n                     permutations = 999)\n\nanova_terms\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for capscale under reduced model\nTerms added sequentially (first to last)\nPermutation: free\nNumber of permutations: 999\n\nModel: capscale(formula = unifrac_vegdist_phychem30cm ~ Temperature...C. + Salinity..ppm. + pH + Redox.mV..Eh. + S.2..mg.l. + SO....mg.l., data = phychem)\n                 Df SumOfSqs    F Pr(>F)  \nTemperature...C.  1    0.208 3.23  0.016 *\nSalinity..ppm.    1    0.120 1.87  0.112  \npH                1    0.064 1.00  0.433  \nRedox.mV..Eh.     1    0.051 0.79  0.565  \nS.2..mg.l.        1    0.108 1.67  0.151  \nSO....mg.l.       1    0.059 0.92  0.470  \nResidual          6    0.385              \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# variance by each axis\nsummary(dbrda_result)$cont$importance\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nImportance of components:\n                       CAP1  CAP2   CAP3   CAP4   CAP5   CAP6  MDS1   MDS2\nEigenvalue            0.324 0.117 0.0814 0.0403 0.0263 0.0207 0.261 0.0425\nProportion Explained  0.325 0.117 0.0818 0.0405 0.0265 0.0208 0.263 0.0427\nCumulative Proportion 0.325 0.443 0.5247 0.5652 0.5916 0.6124 0.875 0.9180\n                        MDS3   MDS4   MDS5   MDS6\nEigenvalue            0.0261 0.0242 0.0180 0.0133\nProportion Explained  0.0262 0.0244 0.0181 0.0134\nCumulative Proportion 0.9442 0.9685 0.9866 1.0000\n```\n\n\n:::\n:::\n\n\n\n\n\n## 03.5 PERMANOVA\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# PERMANOVA\nset.seed(123)\npermanova_result <- adonis2(unifrac_distances_phychem30cm ~ Temperature...C. + Salinity..ppm. + pH +\nRedox.mV..Eh. + S.2..mg.l. + SO....mg.l., \ndata = phychem, by=\"terms\", permutations = 999)\n\n# show\npermanova_result\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nTerms added sequentially (first to last)\nPermutation: free\nNumber of permutations: 999\n\nadonis2(formula = unifrac_distances_phychem30cm ~ Temperature...C. + Salinity..ppm. + pH + Redox.mV..Eh. + S.2..mg.l. + SO....mg.l., data = phychem, permutations = 999, by = \"terms\")\n                 Df SumOfSqs    R2    F Pr(>F)  \nTemperature...C.  1    0.208 0.209 3.23  0.017 *\nSalinity..ppm.    1    0.120 0.121 1.87  0.122  \npH                1    0.064 0.065 1.00  0.406  \nRedox.mV..Eh.     1    0.051 0.051 0.79  0.565  \nS.2..mg.l.        1    0.108 0.108 1.67  0.172  \nSO....mg.l.       1    0.059 0.059 0.92  0.459  \nResidual          6    0.385 0.388              \nTotal            12    0.995 1.000              \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n\n## 03.6 PERMANOVA Plot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract PERMANOVA results\npermanova_df <- data.frame(\n  Variable = rownames(permanova_result)[1:(nrow(permanova_result)-2)],\n  R2 = permanova_result$R2[1:(nrow(permanova_result)-2)],\n  p_value = permanova_result$`Pr(>F)`[1:(nrow(permanova_result)-2)])\n\n# names\nvar_abbrevs <- c(\n  \"Temperature...C.\" = \"Temperature\",\n  \"Salinity..ppm.\" = \"Salinity\",\n  \"pH\" = \"pH\",\n  \"Redox.mV..Eh.\" = \"Redox\",\n  \"S.2..mg.l.\" = \"S2\",\n  \"SO....mg.l.\" = \"Sulfates\")\n\npermanova_df$Variable <- var_abbrevs[permanova_df$Variable]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot\npermanova_plot <- ggplot(permanova_df, aes(x = Variable, \n                        y = R2, fill = p_value < 0.05)) +\n  geom_bar(stat = \"identity\") +\n  scale_fill_manual(values = c(\"TRUE\" = \"cyan4\", \"FALSE\" = \"gray80\"), \n                labels = c(\"TRUE\" = \"p < 0.05\", \"FALSE\" = \"p ≥ 0.05\")) +\n  labs(x = \"Environmental variable\", \n       y = \"R² Proportion of Variance Explained\", \n       fill = \"Significance\") +\n  theme_classic() +\n  theme(\n    axis.text = element_text(size = 9),\n    axis.title = element_text(size = 12),\n    legend.text = element_text(size = 12),\n    legend.title = element_text(size = 12),\n    plot.title = element_text(size = 12))\n\n# show\npermanova_plot\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-39-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"Figures/interior_mangroves/Physicochemyc_Significance.pdf\", permanova_plot, bg='transparent', width = 5.7, height = 4)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in grid.Call.graphics(C_text, as.graphicsAnnot(x$label), x$x, x$y, :\nfor 'p ≥ 0.05' in 'mbcsToSbcs': >= substituted for ≥ (U+2265)\n```\n\n\n:::\n:::\n\n\n\n\n\n## 03.7 dbRDA Plot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract site scores\nscores_samples <- scores(dbrda_result, display = \"sites\")\n\n# Convert to data.frame\nscores_df <- data.frame(scores_samples, Location = phychem$Locality)\n\n# Extra environmental scores\nenv_scores <- scores(dbrda_result, display = \"bp\")\nenv_scores_df <- data.frame(env_scores)\nenv_scores_df$Variable <- rownames(env_scores_df)\n\n# Explain variance percentage\nexplained_var <- summary(dbrda_result)$cont$importance[2, 1:2] * 100  # CAP1 and CAP2\n\n#plot\ncapphychem_plot <- ggplot(scores_df, aes(x = CAP1, y = CAP2, \n  color = Location)) + geom_point(size = 5) + theme_classic() +  \n  labs(\n    col = \"Location\",\n    title = \"db-RDA Unweighted UniFrac\",\n    x = paste0(\"CAP1 (\", round(explained_var[1], 1), \"%)\"),\n    y = paste0(\"CAP2 (\", round(explained_var[2], 1), \"%)\")\n  ) +\n  scale_color_manual(values = loc_colors) +  \n  geom_segment(data = env_scores_df, aes(\n    x = 0, y = 0, xend = CAP1, yend = CAP2),\n               arrow = arrow(length = unit(0.15, \"cm\")), \n    color = \"gray20\", size = 0.6) +\n  # environmental variables\n  geom_text(data = env_scores_df, aes(x = CAP1 * 1.1, \n                            y = CAP2 * 1.1, label = Variable),\n            color = \"black\", size = 3.5) +\n  theme(legend.position = \"right\")\n\ncapphychem_plot\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-41-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#save\nggsave(\"Figures/interior_mangroves/dbRDA.pdf\", capphychem_plot, width = 6, height = 4)\n```\n:::\n\n\n\n\n\n# Save rds plots\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# save plots\nnmds_u\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-43-1.png){width=672}\n:::\n\n```{.r .cell-code}\nnmds_wu_fltr\n```\n\n::: {.cell-output-display}\n![](03.3.BetaDiversity_files/figure-html/unnamed-chunk-43-2.png){width=672}\n:::\n\n```{.r .cell-code}\nsaveRDS(nmds_u, \"rds/interior_mangroves/nmds_u.rds\")\nsaveRDS(nmds_wu_fltr, \"rds/interior_mangroves/nmds_wu.rds\")\nsaveRDS(capphychem_plot, \"rds/interior_mangroves/dbRDA.rds\")\n```\n:::\n",
    "supporting": [
      "03.3.BetaDiversity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}