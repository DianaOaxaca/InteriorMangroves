{
  "hash": "8a8bd4d3708e4f10418711412bcbe380",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Relative Abundances\"\n---\n\n\n\n\n## 01. Load libraries\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(phyloseq)\nlibrary(qiime2R)\nlibrary(microbiome)\nlibrary(dplyr)\nlibrary(tibble)\nlibrary(ampvis2)\nlibrary(microbiomeutilities)\nlibrary(tidyr)\n```\n:::\n\n\n\n\n## 02. Prepare data\n\n### **02.1 Create Phyloseq Object**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nps <- qza_to_phyloseq(\n  features = \"data/ASV_table_filter_freq218_emc.qza\",\n  tree = \"data/rooted-tree-iqtree.qza\",\n  taxonomy = \"data/taxonomy.qza\",\n  metadata = \"data/metadata2.tsv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# check\nps\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nphyloseq-class experiment-level object\notu_table()   OTU Table:         [ 7097 taxa and 50 samples ]\nsample_data() Sample Data:       [ 50 samples by 29 sample variables ]\ntax_table()   Taxonomy Table:    [ 7097 taxa by 7 taxonomic ranks ]\nphy_tree()    Phylogenetic Tree: [ 7097 tips and 7096 internal nodes ]\n```\n\n\n:::\n:::\n\n\n\n\n### 02.2 Check data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(microbiome)\nmicrobiome::summarize_phyloseq(ps)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCompositional = NO2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n1] Min. number of reads = 664132] Max. number of reads = 6748463] Total number of reads = 90064984] Average number of reads = 180129.965] Median number of reads = 171486.57] Sparsity = 0.5668845991263916] Any OTU sum to 1 or less? NO8] Number of singletons = 09] Percent of OTUs that are singletons \n        (i.e. exactly one read detected across all samples)010] Number of sample variables are: 29SampleIDDepthDepthsSiteSample_typeDateLocationTemp...C..intSalnidad..ppm.intSalinidad..ppt.intpH.intpHsupRedox.medido.en.campo1Redox.mV..Eh.intTemperatura...C.supSalnidad..ppm.supSalinidad..ppt.supRedox.medido.en.campoRedox.mV..Eh.supS.2..mg.l..campoml.de.muestra1Factor.de.dilucion1S.2..mg.l.ID_MSO.....mg.l..campoml.de.muestra2Factor.de.dilucion2SO.....mg.l.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] \"1] Min. number of reads = 66413\"\n\n[[2]]\n[1] \"2] Max. number of reads = 674846\"\n\n[[3]]\n[1] \"3] Total number of reads = 9006498\"\n\n[[4]]\n[1] \"4] Average number of reads = 180129.96\"\n\n[[5]]\n[1] \"5] Median number of reads = 171486.5\"\n\n[[6]]\n[1] \"7] Sparsity = 0.566884599126391\"\n\n[[7]]\n[1] \"6] Any OTU sum to 1 or less? NO\"\n\n[[8]]\n[1] \"8] Number of singletons = 0\"\n\n[[9]]\n[1] \"9] Percent of OTUs that are singletons \\n        (i.e. exactly one read detected across all samples)0\"\n\n[[10]]\n[1] \"10] Number of sample variables are: 29\"\n\n[[11]]\n [1] \"Sample\"                 \"ID\"                     \"Depth\"                 \n [4] \"Depths\"                 \"Site\"                   \"Sample_type\"           \n [7] \"Date\"                   \"Location\"               \"Temp...C..int\"         \n[10] \"Salnidad..ppm.int\"      \"Salinidad..ppt.int\"     \"pH.int\"                \n[13] \"pHsup\"                  \"Redox.medido.en.campo1\" \"Redox.mV..Eh.int\"      \n[16] \"Temperatura...C.sup\"    \"Salnidad..ppm.sup\"      \"Salinidad..ppt.sup\"    \n[19] \"Redox.medido.en.campo\"  \"Redox.mV..Eh.sup\"       \"S.2..mg.l..campo\"      \n[22] \"ml.de.muestra1\"         \"Factor.de.dilucion1\"    \"S.2..mg.l.\"            \n[25] \"ID_M\"                   \"SO.....mg.l..campo\"     \"ml.de.muestra2\"        \n[28] \"Factor.de.dilucion2\"    \"SO.....mg.l.\"          \n```\n\n\n:::\n:::\n\n\n\n\n### 02.3 Rename mangrove system\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract metadata\nmetadata <- as(sample_data(ps), \"data.frame\")\n\n# Rename specific levels in the Mangrove system column\n#library(dplyr)\nmetadata <- metadata %>%\n  mutate(`Location` = case_when(\n    Location == \"El Cacahuate\" ~ \"Fossil Lagoon\",\n    Location == \"La Piedad\" ~ \"Reforma Waterfalls\",\n    Location == \"Dique Miguelito\" ~ \"Miguelito Dike\",\n    TRUE ~ Location))\n\n# update sample_data in phyloseq object\nsample_data(ps) <- sample_data(metadata)\n```\n:::\n\n\n\n\n### 02.4. Color pallets\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndepth_colors <- c(\"0-15\" = \"#f5e5c4\",\n                 \"16-30\" = \"#baa179\",\n                 \"31-45\" = \"#a67451\",\n                 \"50-75\" = \"#80673b\")\n\nloc_colors <- c(\"Fossil Lagoon\"= \"#A3D9A8\",\n                \"Reforma Waterfalls\" = \"#44C17B\",\n                \"Miguelito Dike\" = \"#2E8B57\")\n```\n:::\n\n\n\n\n### 02.5 Check samples\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Samples Plot\n\n# Reorder samples\nmetadata$Location <- factor(\n  metadata$Location,\n  levels = c(\"Fossil Lagoon\", \"Reforma Waterfalls\", \n             \"Miguelito Dike\"))\n\n#plot\nsamples_plot <- ggplot(metadata, aes(x = Location, y = ..count..,\nfill = Location)) + geom_bar(position = \"dodge\") +\n  facet_wrap(~ Location, scales = \"free_x\") +\n  labs(title = \"Samples of the analysis\", y = \"Number of Samples\",\n       x = \"Mangrove system\") +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 0)) +\n  scale_fill_manual(values = loc_colors)\n\n# show plot\nprint(samples_plot)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The dot-dot notation (`..count..`) was deprecated in ggplot2 3.4.0.\nâ„¹ Please use `after_stat(count)` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](03.1.RelativeAbundances_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n### 02.6 Get full core\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get full core with microbiome\nfull_ps_core_counts <- core(ps, 0, 0.5)\n\n# Check\nps\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nphyloseq-class experiment-level object\notu_table()   OTU Table:         [ 7097 taxa and 50 samples ]\nsample_data() Sample Data:       [ 50 samples by 29 sample variables ]\ntax_table()   Taxonomy Table:    [ 7097 taxa by 7 taxonomic ranks ]\nphy_tree()    Phylogenetic Tree: [ 7097 tips and 7096 internal nodes ]\n```\n\n\n:::\n\n```{.r .cell-code}\nfull_ps_core_counts\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nphyloseq-class experiment-level object\notu_table()   OTU Table:         [ 2048 taxa and 50 samples ]\nsample_data() Sample Data:       [ 50 samples by 29 sample variables ]\ntax_table()   Taxonomy Table:    [ 2048 taxa by 7 taxonomic ranks ]\nphy_tree()    Phylogenetic Tree: [ 2048 tips and 2047 internal nodes ]\n```\n\n\n:::\n:::\n\n\n\n\n### 02.7 Save object in RDS to next analysis\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(ps, \"rds/interior_mangroves/phyloseq.rds\")\n```\n:::\n\n\n\n\n## 03. Relative abundance phyloseq objects\n\n### 03.1 Create ampvis objects\n\nCreate full, core and Site ampvis objects\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(tibble)\n# library(ampvis2)\n# Ampvis object function\ncreate_ampvis_object <- function(pseq) {\n  # create and extract otu table\n  otu_table_ampvis <- data.frame(OTU = rownames(phyloseq::otu_table(pseq)@.Data),\n                                 phyloseq::otu_table(pseq)@.Data,\n                                 phyloseq::tax_table(pseq)@.Data,\n                                 check.names = FALSE)\n\n  # Metadata\n  meta_data_ampvis <- data.frame(phyloseq::sample_data(pseq),\n                                 check.names = FALSE)\n\n  # change index by SampleID\n  meta_data_ampvis <- meta_data_ampvis %>% rownames_to_column(var = \"SampleID\")\n\n  # ampvis object\n  av2 <- amp_load(otu_table_ampvis, meta_data_ampvis)\n  \n  return(av2)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# phyloseq objects\nphyloseq_objects <-list(ps=ps, full_ps_core_counts = full_ps_core_counts)\n\n# Apply function\nampvis_objects <- lapply(phyloseq_objects, create_ampvis_object)\n\nampvis_objects\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$ps\nampvis2 object with 3 elements. \nSummary of OTU table:\n     Samples         OTUs  Total#Reads    Min#Reads    Max#Reads Median#Reads \n          50         7097      9006498        66413       674846     171486.5 \n   Avg#Reads \n   180129.96 \n\nAssigned taxonomy:\n     Kingdom       Phylum        Class        Order       Family        Genus \n  7097(100%) 7077(99.72%) 7043(99.24%) 6811(95.97%) 6795(95.74%) 6672(94.01%) \n     Species \n4818(67.89%) \n\nMetadata variables: 30 \n SampleID, Sample, ID, Depth, Depths, Site, Sample_type, Date, Location, Temp...C..int, Salnidad..ppm.int, Salinidad..ppt.int, pH.int, pHsup, Redox.medido.en.campo1, Redox.mV..Eh.int, Temperatura...C.sup, Salnidad..ppm.sup, Salinidad..ppt.sup, Redox.medido.en.campo, Redox.mV..Eh.sup, S.2..mg.l..campo, ml.de.muestra1, Factor.de.dilucion1, S.2..mg.l., ID_M, SO.....mg.l..campo, ml.de.muestra2, Factor.de.dilucion2, SO.....mg.l.\n\n$full_ps_core_counts\nampvis2 object with 3 elements. \nSummary of OTU table:\n     Samples         OTUs  Total#Reads    Min#Reads    Max#Reads Median#Reads \n          50         2048      6092185        45680       451490       114651 \n   Avg#Reads \n    121843.7 \n\nAssigned taxonomy:\n     Kingdom       Phylum        Class        Order       Family        Genus \n  2048(100%) 2043(99.76%) 2031(99.17%)  1960(95.7%) 1957(95.56%) 1913(93.41%) \n     Species \n1336(65.23%) \n\nMetadata variables: 30 \n SampleID, Sample, ID, Depth, Depths, Site, Sample_type, Date, Location, Temp...C..int, Salnidad..ppm.int, Salinidad..ppt.int, pH.int, pHsup, Redox.medido.en.campo1, Redox.mV..Eh.int, Temperatura...C.sup, Salnidad..ppm.sup, Salinidad..ppt.sup, Redox.medido.en.campo, Redox.mV..Eh.sup, S.2..mg.l..campo, ml.de.muestra1, Factor.de.dilucion1, S.2..mg.l., ID_M, SO.....mg.l..campo, ml.de.muestra2, Factor.de.dilucion2, SO.....mg.l.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#subset amp obj\n\nav2_full <- ampvis_objects$ps\nav2_full_core <- ampvis_objects$full_ps_core_counts\n```\n:::\n\n\n\n\n### 03.2 Kingdom\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nav2_full$metadata$Depth <- factor(av2_full$metadata$Depths, levels = c(\"0-15\", \"16-30\", \"31-45\", \"50-75\"))\nampv_heatmap_abundances_king_full <- amp_heatmap(av2_full,\n            group_by = \"Depth\",\n            facet_by =  \"Location\",\n            plot_values = TRUE,\n            tax_show = 25,\n            tax_aggregate = \"Kingdom\",\n            plot_colorscale = \"log10\",\n             plot_values_size = 3,\n            color_vector = c(\"deepskyblue3\", \"yellow3\" ,\"magenta3\"))+\n  theme(axis.text.x = element_text(angle = 0, size=9, \n                                   hjust = 0.5, vjust = 0.5),\n        axis.text.y = element_text(size=12, hjust = 1),\n        legend.position=\"right\")\n\nampv_heatmap_abundances_king_full\n```\n\n::: {.cell-output-display}\n![](03.1.RelativeAbundances_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# save\nggsave(\"Figures/interior_mangroves/RelAbundances_king.pdf\", last_plot(),width = 16, height = 4.5, units = \"cm\" )\n```\n:::\n\n\n\n\nGet data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(microbiome)\n# library(microbiomeutilities)\n# library(dplyr)\n\nking_abundances <- taxa_summary(ps,\"Kingdom\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nData provided is not compositional \n will first transform\n```\n\n\n:::\n\n```{.r .cell-code}\nking_abundances\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         Taxa        Max.Rel.Ab        Mean.Rel.Ab      Median.Rel.Ab\n1  d__Archaea 0.132017376126457 0.0231528152808648 0.0141264487609834\n2 d__Bacteria 0.999715207898234  0.976847184719135  0.985873551239017\n             Std.dev\n1 0.0247080819800889\n2 0.0247080819800889\n```\n\n\n:::\n:::\n\n\n\n\n### 03.3 Phylum full\n\nplot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nampv_heatmap_abundances_phylum_loc_full <- amp_heatmap(av2_full,\n            group_by = \"Depth\",\n            facet_by = \"Location\",\n            plot_values = TRUE,\n            tax_show = 30,\n            showRemainingTaxa = TRUE,\n            tax_aggregate = \"Phylum\",\n            tax_add = \"Kingdom\",\n            plot_colorscale = \"log10\",\n            plot_values_size = 2.6,\n            color_vector = c(\"deepskyblue3\", \"yellow3\" ,\"magenta3\"))+\n  theme(axis.text.x = element_text(angle = 0, size=8, \n                                   vjust = 1, hjust = 0.5),\n        axis.text.y = element_text(size=9),\n        legend.position=\"right\")\n\nampv_heatmap_abundances_phylum_loc_full\n```\n\n::: {.cell-output-display}\n![](03.1.RelativeAbundances_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\\*\\*Get info\\*\\*\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(ampvis2)\n#heatmap\nphy_ab_depth <- amp_heatmap(av2_full,\n            #group_by = \"Depth\",\n            facet_by =   c(\"Depth\",\"Site\",\"Location\"),\n            plot_values = FALSE,\n            tax_show = 30,\n            textmap = TRUE,\n            tax_aggregate = \"Phylum\")\n\n\n# library(dplyr)\n# library(tidyr)\n# library(tibble)\n\n# Transform data.frame to long format\nphy_ab_long <- phy_ab_depth %>%\n  rownames_to_column(\"Phylum\") %>% \n  pivot_longer(\n    cols = -Phylum, \n    names_to = \"Sample_Location\", \n    values_to = \"Abundance\"\n  ) %>%\n  separate(Sample_Location, into = c(\"Sample\",\"Depth\", \"Site\", \"Location\"), sep = \" \") %>%\n  mutate(\n    Depth = gsub(\"-cm\", \"\", Depth)  # Clean depth name\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Expected 4 pieces. Additional pieces discarded in 1500 rows [1, 2, 3, 4, 5, 6,\n7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, ...].\n```\n\n\n:::\n\n```{.r .cell-code}\n# mean and sd Depth and Location\nphy_ab_summary_stats <- phy_ab_long %>%\n  group_by(Phylum, Depth, Location) %>%\n  summarise(\n    mean_abundance = mean(Abundance, na.rm = TRUE),\n    sd_abundance = sd(Abundance, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\n# show\nphy_ab_summary_stats\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 360 Ã— 5\n   Phylum          Depth Location  mean_abundance sd_abundance\n   <chr>           <chr> <chr>              <dbl>        <dbl>\n 1 Acidobacteriota 0-15  Fossil              6.96        0.808\n 2 Acidobacteriota 0-15  Miguelito           5.27        1.75 \n 3 Acidobacteriota 0-15  Reforma             5.59        1.35 \n 4 Acidobacteriota 16-30 Fossil              7.17        0.870\n 5 Acidobacteriota 16-30 Miguelito           6.48        0.845\n 6 Acidobacteriota 16-30 Reforma             4.47        0.717\n 7 Acidobacteriota 31-45 Fossil              6.65        1.01 \n 8 Acidobacteriota 31-45 Miguelito           6.50        1.21 \n 9 Acidobacteriota 31-45 Reforma             4.77        1.19 \n10 Acidobacteriota 50-75 Fossil              8.87        1.87 \n# â„¹ 350 more rows\n```\n\n\n:::\n\n```{.r .cell-code}\n# Format table\nphy_depth_table <- phy_ab_summary_stats %>%\n  pivot_wider(\n    names_from = Location,\n    values_from = c(mean_abundance, sd_abundance),\n    names_sep = \"_\"\n  )\n\nphy_depth_table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 120 Ã— 8\n   Phylum           Depth mean_abundance_Fossil mean_abundance_Miguelito\n   <chr>            <chr>                 <dbl>                    <dbl>\n 1 Acidobacteriota  0-15                 6.96                      5.27 \n 2 Acidobacteriota  16-30                7.17                      6.48 \n 3 Acidobacteriota  31-45                6.65                      6.50 \n 4 Acidobacteriota  50-75                8.87                      6.12 \n 5 Actinobacteriota 0-15                 3.75                      3.52 \n 6 Actinobacteriota 16-30                2.84                      2.31 \n 7 Actinobacteriota 31-45                3.73                      2.77 \n 8 Actinobacteriota 50-75                3.05                      3.15 \n 9 Armatimonadota   0-15                 0.0361                    0.193\n10 Armatimonadota   16-30                0.231                     0.407\n# â„¹ 110 more rows\n# â„¹ 4 more variables: mean_abundance_Reforma <dbl>, sd_abundance_Fossil <dbl>,\n#   sd_abundance_Miguelito <dbl>, sd_abundance_Reforma <dbl>\n```\n\n\n:::\n\n```{.r .cell-code}\n# save\nwrite.table(phy_depth_table, \"Tables/Phylum_depth_location_stats.tsv\", row.names = FALSE, sep = \"\\t\", quote = FALSE)\n```\n:::\n\n\n\n\n### 03.4 Phylum Core\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Factor Depth_cm \nav2_full_core$metadata$Depth <- factor(av2_full_core$metadata$Depths, levels = c(\"0-15\", \"16-30\", \"31-45\", \"50-75\"))\n\n# Full all samples\nampv_heatmap_abundances_phylum_core <- amp_heatmap(av2_full_core,\n            group_by = \"Depth\",\n            facet_by = \"Location\",\n            plot_values = TRUE,\n            tax_show = 30,\n            showRemainingTaxa = TRUE,\n            tax_aggregate = \"Phylum\",\n            tax_add = \"Kingdom\",\n            plot_colorscale = \"log10\",\n            plot_values_size = 2.6,\n            color_vector = c(\"deepskyblue3\", \"yellow3\" ,\"magenta3\"))+\n  theme(axis.text.x = element_text(angle = 0, size=8, \n                                   vjust = 1, hjust = 0.5),\n        axis.text.y = element_text(size=9),\n        legend.position=\"right\")\n\nampv_heatmap_abundances_phylum_core\n```\n\n::: {.cell-output-display}\n![](03.1.RelativeAbundances_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\n### 03.5 Combine plots\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cowplot)\n#Combine venn plot\ntitle_abund_plot <- ggdraw() + draw_label(\"Relative Abundance\", fontface = 'bold', x = 0.5, hjust = 0.5, size = 15)\nampv_all_phylum_plots <- plot_grid(title_abund_plot, ampv_heatmap_abundances_phylum_loc_full, ampv_heatmap_abundances_phylum_core, labels = c(\"\", \"A\", \"B\"), ncol = 1, rel_heights = c(0.10, 1.2, 1.2))\n\nampv_all_phylum_plots\n```\n\n::: {.cell-output-display}\n![](03.1.RelativeAbundances_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#save\nggsave(\"Figures/interior_mangroves/Abundances_Phylum_full_and_core.pdf\", ampv_all_phylum_plots, width = 18, height = 30, units = \"cm\")\n```\n:::\n\n\n\n\n## Dominants\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#psgen <- aggregate_taxa(p0,\"Genus\")\ntax_dominant <- dominant_taxa(ps,level = \"Phylum\", group=\"Location\")\nhead(tax_dominant$dominant_overview)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 Ã— 5\n# Groups:   Location [3]\n  Location           dominant_taxa      n rel.freq rel.freq.pct\n  <chr>              <chr>          <int>    <dbl> <chr>       \n1 Fossil Lagoon      Proteobacteria    13     92.9 93%         \n2 Miguelito Dike     Chloroflexi       13     54.2 54%         \n3 Miguelito Dike     Proteobacteria     9     37.5 38%         \n4 Reforma Waterfalls Proteobacteria     8     66.7 67%         \n5 Reforma Waterfalls Chloroflexi        3     25   25%         \n6 Miguelito Dike     Firmicutes         2      8.3 8%          \n```\n\n\n:::\n:::\n",
    "supporting": [
      "03.1.RelativeAbundances_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}