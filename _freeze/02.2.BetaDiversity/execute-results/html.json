{
  "hash": "4b793c6409945410d691dc78c25a6404",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Beta diversity\"\n---\n\n\n\n\n::: callout-tip\nThe analysis of beta diversity was conducted using both NMDS and PERMANOVA to identify the factors that influenced the structure of the microbial community.\n:::\n\n------------------------------------------------------------------------\n\n## Load libraries and prepare data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load libraries\nlibrary(vegan)\nlibrary(phyloseq)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(tidyverse)\nlibrary(pairwiseAdonis)\nlibrary(reshape2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#load data\nphyseq_qiime3 <- readRDS(\"rds/compare_mangroves/physeq_qiime3.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Mangrove system colors\nloc_colors <- c(\"Fossil Lagoon\"= \"#A7fcc1\",\n                \"San Pedro River\" = \"#26B170\",\n                \"Términos Lagoon\" = \"#329D9C\",\n                \"Celestún Lagoon\" = \"#41e8d3\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract data from phyloseq object\n#library(phyloseq)\notu_data <- otu_table(physeq_qiime3, taxa_are_rows = TRUE)\nmetadata <- as(sample_data(physeq_qiime3), \"data.frame\")\n\nsample_data <- data.frame(sample_data(physeq_qiime3))\n```\n:::\n\n\n\n\n## 01. NMDS\n\n### Get distances and stress\n\n::: callout-note\nBray-Curtis dissimilarity distances are a measure of the dissimilarity between microbial communities based on their species composition.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(vegan)\n# library(dplyr)\n# distances\nset.seed(123)\nbray=vegdist(t(otu_data), method = \"bray\")\nnmds_source_bray = vegan::metaMDS(bray, trymax = 20, k = 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRun 0 stress 0.11 \nRun 1 stress 0.078 \n... New best solution\n... Procrustes: rmse 0.111  max resid 0.476 \nRun 2 stress 0.161 \nRun 3 stress 0.078 \n... Procrustes: rmse 4.1e-05  max resid 0.00012 \n... Similar to previous best\nRun 4 stress 0.11 \nRun 5 stress 0.133 \nRun 6 stress 0.11 \nRun 7 stress 0.078 \n... Procrustes: rmse 1.87e-05  max resid 6.06e-05 \n... Similar to previous best\nRun 8 stress 0.161 \nRun 9 stress 0.0782 \n... Procrustes: rmse 0.015  max resid 0.057 \nRun 10 stress 0.133 \nRun 11 stress 0.11 \nRun 12 stress 0.166 \nRun 13 stress 0.145 \nRun 14 stress 0.078 \n... Procrustes: rmse 4.39e-05  max resid 0.000144 \n... Similar to previous best\nRun 15 stress 0.0782 \n... Procrustes: rmse 0.015  max resid 0.0572 \nRun 16 stress 0.0782 \n... Procrustes: rmse 0.015  max resid 0.0571 \nRun 17 stress 0.155 \nRun 18 stress 0.0782 \n... Procrustes: rmse 0.015  max resid 0.0572 \nRun 19 stress 0.0782 \n... Procrustes: rmse 0.015  max resid 0.0571 \nRun 20 stress 0.078 \n... New best solution\n... Procrustes: rmse 4.37e-05  max resid 0.000133 \n... Similar to previous best\n*** Best solution repeated 1 times\n```\n\n\n:::\n\n```{.r .cell-code}\n# stress\nvar_stress_nmds_bray <- round(nmds_source_bray$stress, 5)\n\n# score\nscores_source_bray= nmds_source_bray %>% vegan::scores()\n```\n:::\n\n\n\n\n### Plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(ggplot2)\n# library(tidyverse)\n\nnmds_plot_bray <- ggplot() +\n  geom_point(data=data.frame(scores_source_bray) %>%\n               rownames_to_column(var = \"SampleID\")%>%\n               left_join(metadata, by = \"SampleID\"),\n             aes(x=NMDS1, y=NMDS2,  color = Mangrove.system, \n                 shape = Mangrove_type),\n             size=5) + theme_linedraw()+\n  scale_fill_manual(values = loc_colors)+\n  scale_color_manual(values = loc_colors)+\n  theme(axis.text = element_text(colour = \"black\", size = 12),\n        axis.title = element_text(colour = \"black\", size = 12),\n        legend.text = element_text(size = 10),\n        legend.title = element_text(size = 12),\n        legend.position = \"right\",\n        legend.box = \"vertical\")+ theme_bw() +\n  labs(title=\"Bray-Curtis distances\") +\n  ylab(\"NMDS2\")+xlab(\"NMDS1\")\n\n## stress legend\nnmds_plot_bray <- nmds_plot_bray +\n  annotate(\"text\", x = Inf, y = -Inf,\n           label = paste(\"Stress:\", var_stress_nmds_bray),\n           hjust = 1.1, vjust = -1.1, size = 4)\n\n# show plot\nnmds_plot_bray\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n## 02. PERMANOVA\n\n::: callout-note\nTo test the effects of Mangrove type and Mangrove system on the Bray-Curtis dissimilarity, a PERMANOVA analysis was conducted using adonis2.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract and transpose OTU table\notu_mat <- t(otu_table(physeq_qiime3))\n\n# PERMANOVA with adonis2\nset.seed(123)\nadonis_result <- adonis2(otu_mat ~ Mangrove_type * Mangrove.system,\n                         data = sample_data,\n                         method = \"bray\",\n                         permutations = 999,\n                         by = \"terms\")\n\n# show adonis result\nprint(adonis_result)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPermutation test for adonis under reduced model\nTerms added sequentially (first to last)\nPermutation: free\nNumber of permutations: 999\n\nadonis2(formula = otu_mat ~ Mangrove_type * Mangrove.system, data = sample_data, permutations = 999, method = \"bray\", by = \"terms\")\n                Df SumOfSqs    R2     F Pr(>F)    \nMangrove_type    1     1.77 0.283 11.60  0.001 ***\nMangrove.system  2     1.29 0.206  4.23  0.001 ***\nResidual        21     3.20 0.511                 \nTotal           24     6.25 1.000                 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n### Plot with PERMANOVA results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#add to plot\nnmds_plot_bray_perm <- nmds_plot_bray + annotate(\"text\", x = Inf, y = -Inf,\n           label = paste(\"PERMANOVA:\",\n                         \"Mangrove system: R² = 0.206, p = 0.001\\n\",\n                         \"Mangrove type: R² = 0.283, p = 0.001\\n\",\n                         \"Residual: R² = 0.511\"),\n           hjust = 1.1, vjust = -7, size = 4)\n\n# Mostrar el gráfico\nprint(nmds_plot_bray_perm)\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#save\nggsave(\"Figures/SurfaceComparison/beta-diversity.pdf\", nmds_plot_bray_perm, width = 7.3, height = 5.5)\n```\n:::\n\n\n\n\n## 03. Post-hoc adonis\n\n::: callout-note\nTo test differences between the Mangrove systems a Post-hoc pairwise PERMANOVA was conducted using pairwise.adonis\n:::\n\n### Pairwise adonis\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Post-hoc Mangrove.system\n#library(pairwiseAdonis)\npairwise_adonis <- pairwiseAdonis::pairwise.adonis2(otu_mat ~ \n                  Mangrove.system, data = sample_data, \n                  method = \"bray\",  permutations = 999)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSet of permutations < 'minperm'. Generating entire set.\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(pairwise_adonis)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$parent_call\n[1] \"otu_mat ~ Mangrove.system , strata = Null , permutations 999\"\n\n$`San Pedro River_vs_Fossil Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)   \nModel     1    0.274 0.256 3.09  0.003 **\nResidual  9    0.798 0.744               \nTotal    10    1.071 1.000               \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`San Pedro River_vs_Celestún Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)    \nModel     1     1.39 0.378 9.73  0.001 ***\nResidual 16     2.28 0.622                \nTotal    17     3.67 1.000                \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`San Pedro River_vs_Términos Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)  \nModel     1     1.15 0.476 7.26  0.014 *\nResidual  8     1.26 0.524              \nTotal     9     2.41 1.000              \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`Fossil Lagoon_vs_Celestún Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)   \nModel     1     1.04 0.351 7.03  0.004 **\nResidual 13     1.93 0.649               \nTotal    14     2.98 1.000               \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`Fossil Lagoon_vs_Términos Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)  \nModel     1    1.005 0.523 5.48  0.035 *\nResidual  5    0.916 0.477              \nTotal     6    1.921 1.000              \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$`Celestún Lagoon_vs_Términos Lagoon`\n         Df SumOfSqs    R2    F Pr(>F)   \nModel     1     1.01 0.297 5.07  0.003 **\nResidual 12     2.40 0.703               \nTotal    13     3.41 1.000               \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nattr(,\"class\")\n[1] \"pwadstrata\" \"list\"      \n```\n\n\n:::\n:::\n\n\n\n\n### P-values matrix\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# heatmap \n# library(ggplot2)\n# library(reshape2)\n\n#  p-values of pairwise_adonis\np_values <- c(\n  \"San Pedro River_vs_Fossil Lagoon\" = 0.004,\n  \"San Pedro River_vs_Celestún Lagoon\" = 0.001,\n  \"San Pedro River_vs_Términos Lagoon\" = 0.007,\n  \"Fossil Lagoon_vs_Celestún Lagoon\" = 0.001,\n  \"Fossil Lagoon_vs_Términos Lagoon\" = 0.02,\n  \"Celestún Lagoon_vs_Términos Lagoon\" = 0.003\n)\n\n# matrix of p-values\nlocations <- c(\"San Pedro River\", \"Fossil Lagoon\", \"Celestún Lagoon\", \"Términos Lagoon\")\np_matrix <- matrix(NA, nrow = length(locations), ncol = length(locations),\n                   dimnames = list(locations, locations))\n\n# Fill matrix with p-values (only for the upper half then make symmetrical)\npairs <- strsplit(names(p_values), \"_vs_\")\nfor (i in seq_along(pairs)) {\n  row_name <- pairs[[i]][1]\n  col_name <- pairs[[i]][2]\n  p_matrix[row_name, col_name] <- p_values[i]\n  p_matrix[col_name, row_name] <- p_values[i]  # symmetrical\n}\ndiag(p_matrix) <- 1  # compare with itself\n\n# long format\np_melt <- melt(p_matrix)\n```\n:::\n\n\n\n\n### Heatmap of adonis posthoc\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# heatmap\nheatmap_plot <- ggplot(p_melt, aes(x = Var1, y = Var2, fill = value)) +\n  geom_tile(color = \"white\") +\n  scale_fill_gradient2(low = \"blue\", mid = \"white\", high = \"red\",\n                       midpoint = 0.025, limits = c(0, 0.05),\n                       name = \"p-value\") +\n  geom_text(aes(label = sprintf(\"%.3f\", value)), color = \"black\", size = 3) +\n  theme_minimal() +\n  labs(title = \"Pairwise PERMANOVA post-hoc)\",\n       x = \"Mangrove system\", y = \"Mangrove system\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.title = element_text(size = 12),\n        plot.title = element_text(size = 14))\n\n# Mostrar el gráfico\nprint(heatmap_plot)\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n## 04. Beta disper\n\n::: callout-note\nTo validate the dissimilarity of the data, and to determine whether the differences found are due to changes in composition or to variations in dispersion within groups, the homogeneity of the dispersions between Mangrove type and Mangrove system was calculated using betadisper. Subsequently, the significance of the differences in dispersion was calculated with permutest\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(vegan)\n# library(phyloseq)\n# Bray distance matrix\ndist_matrix <- phyloseq::distance(physeq_qiime3, method = \"bray\")\n```\n:::\n\n\n\n\n### By Mangrove system\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# betadisper\ndisp_location <- betadisper(dist_matrix, sample_data$Mangrove.system)\nprint(summary(disp_location))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                Length Class  Mode   \neig              24    -none- numeric\nvectors         600    -none- numeric\ndistances        25    -none- numeric\ngroup            25    factor numeric\ncentroids        96    -none- numeric\ngroup.distances   4    -none- numeric\ncall              3    -none- call   \n```\n\n\n:::\n:::\n\n\n\n\nPermutest\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Significance permutest\nperm_location <- permutest(disp_location, permutations = 999)\nprint(perm_location)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nPermutation test for homogeneity of multivariate dispersions\nPermutation: free\nNumber of permutations: 999\n\nResponse: Distances\n          Df Sum Sq Mean Sq    F N.Perm Pr(>F)  \nGroups     3  0.143  0.0476 4.55    999  0.022 *\nResiduals 21  0.220  0.0105                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plots\nplot(disp_location, main = \"Beta Dispersión por Mangrove system\")\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n```{.r .cell-code}\nboxplot(disp_location, main = \"Distancias al centroide por Mangrove system\")\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-15-2.png){width=672}\n:::\n:::\n\n\n\n\n### By Mangrove type\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Betadisper Mangrove_type\ndisp_mangrove_type <- betadisper(dist_matrix, sample_data$Mangrove_type)\nprint(summary(disp_mangrove_type))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                Length Class  Mode   \neig              24    -none- numeric\nvectors         600    -none- numeric\ndistances        25    -none- numeric\ngroup            25    factor numeric\ncentroids        48    -none- numeric\ngroup.distances   2    -none- numeric\ncall              3    -none- call   \n```\n\n\n:::\n\n```{.r .cell-code}\n# Significance permutest\nperm_mangrove_type <- permutest(disp_mangrove_type, permutations = 999)\nprint(perm_mangrove_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nPermutation test for homogeneity of multivariate dispersions\nPermutation: free\nNumber of permutations: 999\n\nResponse: Distances\n          Df Sum Sq Mean Sq   F N.Perm Pr(>F)  \nGroups     1  0.154  0.1537 7.2    999  0.014 *\nResiduals 23  0.491  0.0213                    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# plots\nplot(disp_mangrove_type, main = \"Betadisper  Mangrove_type\")\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n\n```{.r .cell-code}\nboxplot(disp_mangrove_type, main = \"Dist to centroid Mangrove_type\")\n```\n\n::: {.cell-output-display}\n![](02.2.BetaDiversity_files/figure-html/unnamed-chunk-17-2.png){width=672}\n:::\n:::\n\n\n\n\n## Save rds beta diversity plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(nmds_plot_bray_perm, \"rds/compare_mangroves/beta-diversity-surface-plot.rds\")\n```\n:::\n",
    "supporting": [
      "02.2.BetaDiversity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}