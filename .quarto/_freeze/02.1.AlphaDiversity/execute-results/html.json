{
  "hash": "440e61fe07925db3ba476b1702d3f346",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Alpha diversity\"\n---\n\n\n\n\n::: callout-tip\nAlpha diversity indices were calculated with Hill numbers (q0 = observed richness, q1 = Shannon Exp and q2 = Inv Simpson). The significance of the observed differences among mangrove systems was determined by employing a linear model, given the imbalanced sample numbers.\n:::\n\n------------------------------------------------------------------------\n\n## Load libraries and prepare data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Load libraries\nlibrary(phyloseq)\nlibrary(hilldiv)\nlibrary(tidyverse)\nlibrary(ggpubr)\nlibrary(ggplot2)\nlibrary(cowplot)\nlibrary(vegan)\nlibrary(emmeans)\nlibrary(multcomp)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#load data\nphyseq_qiime3 <- readRDS(\"rds/compare_mangroves/physeq_qiime3.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Mangrove system colors\nloc_colors <- c(\"Fossil Lagoon\"= \"#A7fcc1\",\n                \"San Pedro River\" = \"#26B170\",\n                \"Términos Lagoon\" = \"#329D9C\",\n                \"Celestún Lagoon\" = \"#41e8d3\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract data from phyloseq object\n#library(phyloseq)\notu_data <- otu_table(physeq_qiime3, taxa_are_rows = TRUE)\nmetadata <- as(sample_data(physeq_qiime3), \"data.frame\")\n```\n:::\n\n\n\n\n## 01. Get Hill numbers\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate hill numbers\n#library(hilldiv)\n\nq0 <- hill_div(otu_data, qvalue = 0)\nq1 <- hill_div(otu_data, qvalue = 1)\nq2 <- hill_div(otu_data, qvalue = 2)\n\n# Merge metadata with Hill numbers\n#library(tidyverse)\nq012 <- cbind(q0, q1, q2) %>% as.data.frame() %>%\n  rownames_to_column(var = \"SampleID\")\n\n# join\nmetadata_with_hill <- q012 %>%\n  inner_join(metadata, by = c(\"SampleID\"=\"SampleID\"))\n\n# show\nmetadata_with_hill %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  SampleID   q0  q1    q2 BioSample  ID    SRA SampleName Collection_date depth\n1   S1A015 1266 330 106.0    S1A015 RSP S1A015                 2023-09-28  0-15\n2    S1B07 1502 164  36.0     S1B07 RSP  S1B07                 2023-09-28  0-15\n3    S2B07 1378 351 106.8     S2B07 RSP  S2B07                 2023-09-28  0-15\n4    S3A07 1190 154  37.6     S3A07 RSP  S3A07                 2023-09-28  0-15\n5    S4B07 1563 388 120.4     S4B07 RSP  S4B07                 2023-09-29  0-15\n6    S5A07 1160 131  32.1     S5A07 RSP  S5A07                 2023-09-29  0-15\n  site elevation Broad_scale_environmental_context\n1   1A        NA                                  \n2   1B        NA                                  \n3   2B        NA                                  \n4   3A        NA                                  \n5   4B        NA                                  \n6   5A        NA                                  \n  Local_scale_environmental_context Environmental_medium Latitude_and_Longitude\n1                                                                              \n2                                                                              \n3                                                                              \n4                                                                              \n5                                                                              \n6                                                                              \n  Geographic.Location    Study_zone Ecological_type Parametros Temperatura\n1      Mexico:Tabasco Rio San Pedro          Fringe         no          NA\n2      Mexico:Tabasco Rio San Pedro          Fringe         no          NA\n3      Mexico:Tabasco Rio San Pedro          Fringe         no          NA\n4      Mexico:Tabasco Rio San Pedro          Fringe         no          NA\n5      Mexico:Tabasco Rio San Pedro          Fringe         no          NA\n6      Mexico:Tabasco Rio San Pedro          Fringe         no          NA\n  Salinidad pH Redox.mV S.2 SO4 season filter Mangrove.system Mangrove_type\n1        NA NA       NA  NA  NA  flood     si San Pedro River      Interior\n2        NA NA       NA  NA  NA  flood     si San Pedro River      Interior\n3        NA NA       NA  NA  NA  flood     si San Pedro River      Interior\n4        NA NA       NA  NA  NA  flood     si San Pedro River      Interior\n5        NA NA       NA  NA  NA  flood     si San Pedro River      Interior\n6        NA NA       NA  NA  NA  flood     si San Pedro River      Interior\n```\n\n\n:::\n\n```{.r .cell-code}\n#save table\nwrite.table(metadata_with_hill, \"Tables/SurfaceComparison/Metadata_with_hill.tsv\",\n            quote = FALSE, sep = \"\\t\", row.names = TRUE, col.names=TRUE)\n```\n:::\n\n\n\n\n## 02. Get Hill means\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Reorder q values\nmeta_qs <- metadata_with_hill %>%\n  pivot_longer(cols = q0:q2, names_to = \"q\", values_to = \"value\") %>%\n  filter(q %in% c(\"q0\", \"q1\", \"q2\")) %>%\n  mutate(\n    qs = case_when(\n      q == \"q0\" ~ \"q0=Observed\",\n      q == \"q1\" ~ \"q1=Exp Shannon\",\n      q == \"q2\" ~ \"q2=Inv Simpson\",\n    ))\n\n#Get means of Hill numbers\nmeans <- meta_qs %>% group_by(Mangrove_type, Mangrove.system, qs) %>%\n  summarise(means = mean(value, na.rm = TRUE),\n            sd = sd(value, na.rm = TRUE),\n            .groups = 'drop')\n\nprint(means)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 5\n   Mangrove_type Mangrove.system qs              means    sd\n   <chr>         <chr>           <chr>           <dbl> <dbl>\n 1 Coastal       Celestún Lagoon q0=Observed    1202   207. \n 2 Coastal       Celestún Lagoon q1=Exp Shannon  496.   87.6\n 3 Coastal       Celestún Lagoon q2=Inv Simpson  234.   40.5\n 4 Coastal       Términos Lagoon q0=Observed     140    61.8\n 5 Coastal       Términos Lagoon q1=Exp Shannon   78.8  48.9\n 6 Coastal       Términos Lagoon q2=Inv Simpson   51.2  32.7\n 7 Interior      Fossil Lagoon   q0=Observed    1230   134. \n 8 Interior      Fossil Lagoon   q1=Exp Shannon  300.   75.1\n 9 Interior      Fossil Lagoon   q2=Inv Simpson   86.5  26.9\n10 Interior      San Pedro River q0=Observed    1368.  166. \n11 Interior      San Pedro River q1=Exp Shannon  254.  105. \n12 Interior      San Pedro River q2=Inv Simpson   71.7  38.4\n```\n\n\n:::\n\n```{.r .cell-code}\n#save table\nwrite.table(means, \"Tables/SurfaceComparison/Hill_means_sd.tsv\", quote = FALSE,\n            sep = \"\\t\", row.names = TRUE, col.names=TRUE)\n\n# group by mangrove type\nmeans_mangrove_type <- meta_qs %>% group_by(Mangrove_type, qs) %>%\n  summarise(means = mean(value, na.rm = TRUE),\n            sd = sd(value, na.rm = TRUE),\n            .groups = 'drop')\n\nprint(means_mangrove_type)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n  Mangrove_type qs              means    sd\n  <chr>         <chr>           <dbl> <dbl>\n1 Coastal       q0=Observed     974.  488. \n2 Coastal       q1=Exp Shannon  407.  195. \n3 Coastal       q2=Inv Simpson  194.   86.3\n4 Interior      q0=Observed    1318.  163. \n5 Interior      q1=Exp Shannon  271.   94.0\n6 Interior      q2=Inv Simpson   77.1  34.0\n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.table(means, \"Tables/SurfaceComparison/Hill_means_sd_mangrove_type.tsv\", quote = FALSE,\n            sep = \"\\t\", row.names = TRUE, col.names=TRUE)\n```\n:::\n\n\n\n\n## 03. Get sequencing effort\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Sample effort\n#library(vegan)\nmat <- as(t(otu_table(physeq_qiime3)), \"matrix\")\nraremax <- min(rowSums(mat))\n\n# plot\nsystem.time(rarecurve(mat, step = 100, sample = raremax, col = \"green4\", \n                      label = FALSE))\n```\n\n::: {.cell-output-display}\n![](02.1.AlphaDiversity_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   user  system elapsed \n  4.698   0.143   4.846 \n```\n\n\n:::\n\n```{.r .cell-code}\n# save\npdf(\"Figures/SurfaceComparison/sample_effort.pdf\")\nsystem.time(rarecurve(mat, step = 100, sample = raremax, col = \"green4\", \n                      label = FALSE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   user  system elapsed \n  4.939   0.137   5.078 \n```\n\n\n:::\n\n```{.r .cell-code}\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nquartz_off_screen \n                2 \n```\n\n\n:::\n:::\n\n\n\n\n## 04. Get significant differences\n\n::: callout-caution\n## Remember\n\nThe significance of the observed differences among mangrove systems was determined by employing a linear model, given the imbalanced sample numbers.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# change variable to factor\nmetadata_with_hill$Mangrove.system <- \n  factor(metadata_with_hill$Mangrove.system)\n\n# Change to Fossil Lagoon reference\nmetadata_with_hill$Mangrove.system <- \n  relevel(metadata_with_hill$Mangrove.system,ref = \"Fossil Lagoon\")\n```\n:::\n\n\n\n\n### q0 Observed richness\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# linear model adjust\nq0lm <- lm(q0 ~ Mangrove.system, data = metadata_with_hill)\n# summary\nsummary(q0lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = q0 ~ Mangrove.system, data = metadata_with_hill)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-334.0 -102.4    9.6  140.0  247.0 \n\nCoefficients:\n                               Estimate Std. Error t value Pr(>|t|)    \n(Intercept)                      1230.0       88.3   13.93  4.5e-12 ***\nMangrove.systemCelestún Lagoon    -28.0      103.1   -0.27     0.79    \nMangrove.systemSan Pedro River    138.4      110.7    1.25     0.22    \nMangrove.systemTérminos Lagoon  -1090.0      134.9   -8.08  7.0e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 177 on 21 degrees of freedom\nMultiple R-squared:  0.84,\tAdjusted R-squared:  0.817 \nF-statistic: 36.7 on 3 and 21 DF,  p-value: 1.56e-08\n```\n\n\n:::\n\n```{.r .cell-code}\n# check model reliability\nshapiro.test(residuals(q0lm))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  residuals(q0lm)\nW = 1, p-value = 0.4\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# get differences with emmeans\n#library(emmeans)\nq0_lm_means <- emmeans(q0lm, pairwise ~ Mangrove.system)\n\n# get significance letters\n#library(multcomp)\ncld_results <- cld(object = q0_lm_means$emmeans, Letters = letters)\n\n# Convertir a data frame\nq0_emmeans_df <- as.data.frame(cld_results)\nq0_emmeans_df\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Mangrove.system emmean    SE df lower.CL upper.CL .group\n Términos Lagoon    140 102.0 21      -72      352  a    \n Celestún Lagoon   1202  53.3 21     1091     1313   b   \n Fossil Lagoon     1230  88.3 21     1046     1414   b   \n San Pedro River   1368  66.8 21     1230     1507   b   \n\nConfidence level used: 0.95 \nP value adjustment: tukey method for comparing a family of 4 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n\n```{.r .cell-code}\n# Reorder samples\nmetadata_with_hill$Mangrove.system <- factor(\n  metadata_with_hill$Mangrove.system,\n  levels = c(\"Fossil Lagoon\", \"San Pedro River\", \n             \"Términos Lagoon\", \"Celestún Lagoon\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# boxplot with significance\nq0plot <- ggplot(metadata_with_hill, aes(x = Mangrove.system, y = q0, fill = Mangrove.system)) +\n  geom_boxplot() +\n  #geom_jitter(aes(fill = Mangrove.system), width = 0.1, alpha = 0.4) +\n  geom_text(data = q0_emmeans_df, aes(y = emmean, label = .group), vjust = -3,\n          color = \"black\", fontface = \"bold\", position = position_dodge(0.9)) +\n  labs(title = \"Observed\", y = NULL, x = NULL) + #,\n  #caption = \"letters by lm emmeans\") +\n  theme_bw() + scale_fill_manual(values = loc_colors) +\n  theme(legend.position = \"none\", axis.text.x = element_blank())\n```\n:::\n\n\n\n\n### q1 Diversity Exp Shannon\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# linear model\nq1lm <- lm(q1 ~ Mangrove.system, data = metadata_with_hill)\n\n#check model reliability\nshapiro.test(residuals(q1lm))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  residuals(q1lm)\nW = 0.9, p-value = 0.2\n```\n\n\n:::\n\n```{.r .cell-code}\n# significance\nq1_lm_means <- emmeans(q1lm, pairwise ~ Mangrove.system)\ncld_results <- cld(object = q1_lm_means$emmeans, Letters = letters)\n\n# Convert to data frame\nq1_emmeans_df <- as.data.frame(cld_results)\nq1_emmeans_df\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Mangrove.system emmean   SE df lower.CL upper.CL .group\n Términos Lagoon     79 51.1 21      -28      185  a    \n San Pedro River    254 33.5 21      185      324   b   \n Fossil Lagoon      300 44.3 21      208      392   b   \n Celestún Lagoon    496 26.7 21      441      552    c  \n\nConfidence level used: 0.95 \nP value adjustment: tukey method for comparing a family of 4 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# boxplot\nq1plot <- ggplot(metadata_with_hill, aes(x = Mangrove.system , y = q1, fill = Mangrove.system)) +\n  geom_boxplot() +\n  #geom_jitter(aes(fill = Mangrove.system), width = 0.1, alpha = 0.4) +\n  geom_text(data = q1_emmeans_df, aes(y = emmean, label = .group), vjust = -5,\n          color = \"black\", fontface = \"bold\", position = position_dodge(0.9)) +   labs(title = \"Exp Shannon\", y = NULL, x = NULL) + #,\n  #caption = \"letters by lm emmeans\") +\n  theme_bw() + scale_fill_manual(values = loc_colors) +\n  theme(legend.position = \"none\", axis.text.x = element_blank())\n```\n:::\n\n\n\n\n### q2 Dominance Inv Simpson\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model\nq2lm <- lm(q2 ~ Mangrove.system, data = metadata_with_hill)\n#check model reliability\nshapiro.test(residuals(q2lm))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  residuals(q2lm)\nW = 0.9, p-value = 0.2\n```\n\n\n:::\n\n```{.r .cell-code}\n# get significance\nq2_lm_means <- emmeans(q2lm, pairwise ~ Mangrove.system)\ncld_results <- cld(object = q2_lm_means$emmeans, Letters = letters)\n\n# Convert to data frame\nq2_emmeans_df <- as.data.frame(cld_results)\nq2_emmeans_df\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Mangrove.system emmean   SE df lower.CL upper.CL .group\n Términos Lagoon   51.2 21.6 21      6.1     96.2  a    \n San Pedro River   71.7 14.2 21     42.3    101.2  a    \n Fossil Lagoon     86.5 18.8 21     47.5    125.5  a    \n Celestún Lagoon  233.5 11.3 21    210.0    257.0   b   \n\nConfidence level used: 0.95 \nP value adjustment: tukey method for comparing a family of 4 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# boxplot\nq2plot <- ggplot(metadata_with_hill, aes(x = Mangrove.system, y = q2, fill = Mangrove.system)) +\n  geom_boxplot() +\n  #geom_jitter(aes(fill = Mangrove.system), width = 0.1, alpha = 0.4) +\n  geom_text(data = q2_emmeans_df, aes(y = emmean, label = .group), vjust = -5,\n            color = \"black\", fontface = \"bold\", position = position_dodge(0.9)) +\n  labs(title = \"Inv Simpson\", y = NULL, x = NULL,\n  caption = \"letters by lm emmeans\") +\n  theme_bw() + scale_fill_manual(values = loc_colors) +\n  theme(legend.position = \"none\")\n```\n:::\n\n\n\n\n### Combine plots\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Combine alpha diversity plots\n# library(ggplot2)\n# library(cowplot)\n\nytitle <- ggdraw() + draw_label(\"Effective number of ASVs\",\n                                angle = 90, size = 14 )\nq012plot <- plot_grid(q0plot, q1plot, q2plot,\n                      labels = c(\"A)\", \"\", \"\"), ncol = 1)\nq012y_plot <- plot_grid(ytitle, q012plot, ncol = 2, rel_widths = c(0.05, 1))\n\n# show\nq012y_plot\n```\n\n::: {.cell-output-display}\n![](02.1.AlphaDiversity_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# save\nggsave(\"Figures/SurfaceComparison/alphadiv_per_loc.pdf\",\n       q012y_plot, width = 6.3, height = 9.9)\n```\n:::\n\n\n\n\n## Save rds alpha diversity plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(q012y_plot, \"rds/compare_mangroves/alpha_diversity_surface_plot.rds\")\n```\n:::\n",
    "supporting": [
      "02.1.AlphaDiversity_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}